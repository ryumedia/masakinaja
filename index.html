<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masakin Aja - E-commerce Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        .vendor-card {
            transition: all 0.3s ease;
        }
        .vendor-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .cart-badge {
            animation: bounce 0.5s ease-in-out;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Left Section: Logo, Title, and Role Icons -->
                <div class="flex items-center space-x-1 sm:space-x-2">
                    <button onclick="showSection('shopping')" class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-store text-white text-sm"></i>
                        </div>
                        <h1 class="text-xl font-bold text-gray-900">Masakin Aja</h1>
                    </button>
                    <!-- Admin & Vendor Icons -->
                    <button onclick="showSection('admin')" id="adminNav" class="nav-btn text-gray-600 hover:text-blue-600 w-10 h-10 flex items-center justify-center rounded-full hidden transition-colors" title="Panel Admin">
                        <i class="fas fa-cog text-xl"></i>
                    </button>
                    <button onclick="showSection('vendor')" id="vendorNav" class="nav-btn text-gray-600 hover:text-blue-600 w-10 h-10 flex items-center justify-center rounded-full hidden transition-colors" title="Panel Vendor">
                        <i class="fas fa-store text-xl"></i>
                    </button>
                </div>

                <div class="flex items-center space-x-4">
                    <div id="authSection">
                        <div id="loginSection">
                            <button onclick="showAuthModal('login')" class="text-gray-600 hover:text-gray-900 mr-4">
                                <i class="fas fa-sign-in-alt mr-2"></i>Login
                            </button>
                            <button onclick="showAuthModal('register')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-user-plus mr-2"></i>Daftar
                            </button>
                        </div>
                        <div id="userSection" class="hidden flex items-center space-x-4">
                            <button onclick="showSection('cart')" class="relative p-2 text-gray-600 hover:text-gray-900" title="Keranjang Belanja">
                                <i class="fas fa-shopping-cart text-xl"></i>
                                <span id="cartBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                            </button>
                            <button onclick="showSection('orders')" class="p-2 text-gray-600 hover:text-gray-900" title="Riwayat Pesanan">
                                <i class="fas fa-receipt text-xl"></i>
                            </button>
                            <div class="flex items-center space-x-2">
                                <span id="userName" class="text-gray-700 font-medium"></span>
                                <button onclick="logout()" class="text-gray-600 hover:text-red-600 transition-colors" title="Logout">
                                    <i class="fas fa-sign-out-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Shopping Section -->
        <section id="shoppingSection" class="section-content">
            <!-- Type Filter -->
            <div class="mb-8">
                <div id="typeFilterButtons" class="flex flex-wrap gap-3">
                    <button onclick="filterByType(event, '')" class="type-filter-btn bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-blue-700 transition-colors">
                        Semua Tipe
                    </button>
                    <!-- Type filter buttons will be loaded dynamically -->
                </div>
            </div>

            <!-- Products Grid -->
            <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Products will be loaded here -->
            </div>
        </section>

        <!-- Cart Section -->
        <section id="cartSection" class="section-content hidden">
            <div class="max-w-4xl mx-auto">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-bold text-gray-900">Keranjang Belanja</h2>
                    <button onclick="showSection('shopping')" class="text-blue-600 hover:text-blue-800 font-medium">
                        <i class="fas fa-arrow-left mr-2"></i>Kembali Belanja
                    </button>
                </div>
                <div id="cartContent">
                    <!-- Cart items will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Customer Orders Section -->
        <section id="ordersSection" class="section-content hidden">
            <div class="max-w-6xl mx-auto">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-bold text-gray-900">Riwayat Pesanan Saya</h2>
                    <button onclick="showSection('shopping')" class="text-blue-600 hover:text-blue-800 font-medium">
                        <i class="fas fa-arrow-left mr-2"></i>Kembali Belanja
                    </button>
                </div>
                <div id="customerOrdersContent">
                    <!-- Customer orders will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Vendor Section -->
        <section id="vendorSection" class="section-content hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-6">Panel Vendor - <span id="vendorCategoryName" class="text-blue-600"></span></h2>
                
                <!-- Vendor Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <button onclick="showSection('vendorProducts')" class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-6 text-white hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105 w-full text-left">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm font-medium">Produk Saya</p>
                                <p id="vendorTotalProducts" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="bg-green-400 bg-opacity-30 rounded-full p-3">
                                <i class="fas fa-box text-2xl"></i>
                            </div>
                        </div>
                        <div class="mt-2 text-green-100 text-sm">
                            <i class="fas fa-eye mr-1"></i>Klik untuk kelola produk
                        </div>
                    </button>
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">Pesanan Masuk</p>
                                <p id="vendorTotalOrders" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="bg-blue-400 bg-opacity-30 rounded-full p-3">
                                <i class="fas fa-shopping-cart text-2xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm font-medium">Total Pendapatan</p>
                                <p id="vendorTotalRevenue" class="text-3xl font-bold">Rp 0</p>
                            </div>
                            <div class="bg-purple-400 bg-opacity-30 rounded-full p-3">
                                <i class="fas fa-money-bill-wave text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vendor Orders - HANYA PESANAN DARI PRODUK VENDOR INI -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Pesanan Produk Saya</h3>
                        <p class="text-sm text-gray-600 mt-1">Hanya menampilkan pesanan yang berisi produk dari kategori Anda</p>
                    </div>
                    <div id="vendorOrdersTable" class="overflow-x-auto">
                        <!-- Vendor orders will be loaded here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Vendor Products Section -->
        <section id="vendorProductsSection" class="section-content hidden">
            <div class="mb-8">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900">Kelola Produk - <span id="vendorProductsCategoryName" class="text-blue-600"></span></h2>
                        <p class="text-gray-600 mt-1">Kelola semua produk dalam kategori Anda</p>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="showSection('vendor')" class="text-blue-600 hover:text-blue-800 font-medium">
                            <i class="fas fa-arrow-left mr-2"></i>Kembali ke Panel Vendor
                        </button>
                        <button onclick="showAddProductForm()" class="bg-gradient-to-r from-green-500 to-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:from-green-600 hover:to-blue-700 transition-all transform hover:scale-105">
                            <i class="fas fa-plus mr-2"></i>Tambah Produk
                        </button>
                    </div>
                </div>

                <!-- Add Product Form (Hidden by default) -->
                <div id="addProductForm" class="hidden bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Tambah Produk Baru</h3>
                    <p class="text-sm text-gray-600 mb-6">Produk akan otomatis dikategorikan sebagai <span id="autoCategory" class="font-medium text-blue-600"></span></p>
                    
                    <form id="productForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Produk *</label>
                            <input type="text" id="productName" required 
                                   placeholder="Contoh: Kopi Arabica Premium"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Harga *</label>
                            <input type="number" id="productPrice" required min="0" step="1"
                                   placeholder="25000"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stok *</label>
                            <input type="number" id="productStock" required min="0"
                                   placeholder="100"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipe (Opsional)</label>
                            <input type="text" id="productType" placeholder="Contoh: Makanan, Minuman"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                            <input type="text" id="productCategory" readonly 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                            <p class="text-xs text-gray-500 mt-1">Otomatis sesuai kategori vendor Anda</p>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi *</label>
                            <textarea id="productDescription" required rows="3"
                                      placeholder="Deskripsi lengkap produk Anda..."
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">URL Gambar (Opsional)</label>
                            <input type="url" id="productImageUrl" 
                                   placeholder="https://example.com/image.jpg"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">Kosongkan untuk menggunakan gambar default</p>
                        </div>
                        <div class="md:col-span-2 flex space-x-3">
                            <button type="submit" 
                                    class="bg-gradient-to-r from-green-500 to-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:from-green-600 hover:to-blue-700 transition-all">
                                <i class="fas fa-plus mr-2"></i>Tambah Produk
                            </button>
                            <button type="button" onclick="hideAddProductForm()" 
                                    class="bg-gray-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-gray-700 transition-all">
                                <i class="fas fa-times mr-2"></i>Batal
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Products Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Daftar Produk Saya</h3>
                            <div class="text-sm text-gray-600">
                                Total: <span id="totalVendorProductsCount" class="font-medium">0</span> produk
                            </div>
                        </div>
                    </div>
                    <div id="vendorProductsTable" class="overflow-x-auto">
                        <!-- Vendor products table will be loaded here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Admin Products Section -->
        <section id="adminProductsSection" class="section-content hidden">
            <div class="mb-8">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900">Semua Produk</h2>
                        <p class="text-gray-600 mt-1">Daftar semua produk dari seluruh vendor</p>
                    </div>
                    <button onclick="showSection('admin')" class="text-blue-600 hover:text-blue-800 font-medium">
                        <i class="fas fa-arrow-left mr-2"></i>Kembali ke Admin
                    </button>
                </div>

                <!-- Filter Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Filter Produk</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter Vendor</label>
                            <select id="adminProductVendorFilter" onchange="applyAdminProductFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Semua Vendor</option>
                                <!-- Options will be loaded dynamically from database -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status Stok</label>
                            <select id="adminProductStockFilter" onchange="applyAdminProductFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Semua Status</option>
                                <option value="available">Tersedia</option>
                                <option value="low">Stok Rendah (â‰¤10)</option>
                                <option value="out">Habis</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Urutkan</label>
                            <select id="adminProductSortFilter" onchange="applyAdminProductFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="newest">Terbaru</option>
                                <option value="oldest">Terlama</option>
                                <option value="name_asc">Nama A-Z</option>
                                <option value="name_desc">Nama Z-A</option>
                                <option value="price_asc">Harga Terendah</option>
                                <option value="price_desc">Harga Tertinggi</option>
                                <option value="stock_asc">Stok Terendah</option>
                                <option value="stock_desc">Stok Tertinggi</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <div class="text-sm text-gray-600 space-y-1">
                            <div>Menampilkan <span id="filteredProductsCount">0</span> dari <span id="totalProductsCount">0</span> produk</div>
                            <div class="flex space-x-4 text-xs">
                                <span>Tersedia: <span id="availableProductsCount" class="font-medium text-green-600">0</span></span>
                                <span>Stok Rendah: <span id="lowStockProductsCount" class="font-medium text-yellow-600">0</span></span>
                                <span>Habis: <span id="outOfStockProductsCount" class="font-medium text-red-600">0</span></span>
                            </div>
                        </div>
                        <button onclick="resetAdminProductFilters()" class="text-blue-600 hover:text-blue-800 font-medium text-sm">
                            <i class="fas fa-refresh mr-1"></i>Reset Filter
                        </button>
                    </div>
                </div>

                <!-- Products Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Daftar Produk</h3>
                            <div class="text-sm text-gray-600">
                                <i class="fas fa-info-circle mr-1"></i>Mode tampilan saja - tidak dapat mengedit
                            </div>
                        </div>
                    </div>
                    <div id="adminProductsTable" class="overflow-x-auto">
                        <!-- Products table will be loaded here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Vendors Management Section -->
        <section id="vendorsSection" class="section-content hidden">
            <div class="mb-8">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900">Kelola Vendor</h2>
                        <p class="text-gray-600 mt-1">Kelola semua vendor yang terdaftar di platform</p>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="showSection('admin')" class="text-blue-600 hover:text-blue-800 font-medium">
                            <i class="fas fa-arrow-left mr-2"></i>Kembali ke Admin
                        </button>
                        <button onclick="showAddVendorForm()" class="bg-gradient-to-r from-green-500 to-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:from-green-600 hover:to-blue-700 transition-all transform hover:scale-105">
                            <i class="fas fa-plus mr-2"></i>Tambah Vendor
                        </button>
                    </div>
                </div>

                <!-- Add Vendor Form (Hidden by default) -->
                <div id="addVendorForm" class="hidden bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Jadikan User Sebagai Vendor</h3>
                    <p class="text-sm text-gray-600 mb-6">User harus sudah terdaftar terlebih dahulu. Masukkan email user yang akan dijadikan vendor.</p>
                    
                    <!-- Step 1: Check User Email -->
                    <div id="emailCheckStep" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email User</label>
                            <div class="flex space-x-3">
                                <input type="email" id="vendorEmailCheck" required 
                                       placeholder="Masukkan email user yang sudah terdaftar"
                                       class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <button type="button" onclick="checkUserEmail()" 
                                        class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-all">
                                    <i class="fas fa-search mr-2"></i>Cek User
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">User harus sudah mendaftar sebagai customer terlebih dahulu</p>
                        </div>
                    </div>

                    <!-- Step 2: Vendor Details Form (Hidden initially) -->
                    <div id="vendorDetailsStep" class="hidden">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-3"></i>
                                <div>
                                    <p class="font-medium text-green-800">User Ditemukan!</p>
                                    <p class="text-sm text-green-600">Data user akan diupdate menjadi vendor</p>
                                </div>
                            </div>
                        </div>

                        <form id="vendorForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="vendorName" readonly 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                                <p class="text-xs text-gray-500 mt-1">Diambil dari data user yang sudah terdaftar</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" id="vendorEmail" readonly 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kategori Vendor</label>
                                <select id="vendorCategorySelect" required onchange="toggleCustomCategory()"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Pilih Kategori Vendor</option>
                                    <option value="pin-kopi">Pin Kopi</option>
                                    <option value="satset-grill">SatSet Grill</option>
                                    <option value="ani-ksf">Ani KSF</option>
                                    <option value="custom">Kategori Baru (Custom)</option>
                                </select>
                            </div>
                            <div id="customCategoryField" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kategori Custom</label>
                                <input type="text" id="vendorCategoryCustom" 
                                       placeholder="Contoh: toko-elektronik, warung-makan"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">Gunakan format: huruf kecil dengan tanda hubung</p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nomor Telepon</label>
                                <input type="tel" id="vendorPhone" 
                                       placeholder="Kosongkan jika tidak ingin mengubah"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">Opsional - akan mengupdate nomor telepon user</p>
                            </div>
                            <div class="md:col-span-2 flex space-x-3">
                                <button type="submit" 
                                        class="bg-gradient-to-r from-green-500 to-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:from-green-600 hover:to-blue-700 transition-all">
                                    <i class="fas fa-user-tag mr-2"></i>Jadikan Vendor
                                </button>
                                <button type="button" onclick="resetVendorForm()" 
                                        class="bg-gray-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-gray-700 transition-all">
                                    <i class="fas fa-arrow-left mr-2"></i>Kembali
                                </button>
                                <button type="button" onclick="hideAddVendorForm()" 
                                        class="bg-red-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-red-700 transition-all">
                                    <i class="fas fa-times mr-2"></i>Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Vendors Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Daftar Vendor</h3>
                            <div class="text-sm text-gray-600">
                                Total: <span id="totalVendorsCount" class="font-medium">0</span> vendor
                            </div>
                        </div>
                    </div>
                    <div id="vendorsTable" class="overflow-x-auto">
                        <!-- Vendors table will be loaded here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Admin Section -->
        <section id="adminSection" class="section-content hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-6">Panel Admin</h2>
                
                <!-- Admin Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <button onclick="showSection('adminProducts')" class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white hover:from-blue-600 hover:to-blue-700 transition-all transform hover:scale-105 w-full text-left">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">Total Produk</p>
                                <p id="totalProducts" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="bg-blue-400 bg-opacity-30 rounded-full p-3">
                                <i class="fas fa-box text-2xl"></i>
                            </div>
                        </div>
                        <div class="mt-2 text-blue-100 text-sm">
                            <i class="fas fa-eye mr-1"></i>Klik untuk melihat daftar
                        </div>
                    </button>
                    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm font-medium">Total Pesanan</p>
                                <p id="totalOrders" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="bg-green-400 bg-opacity-30 rounded-full p-3">
                                <i class="fas fa-shopping-cart text-2xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm font-medium">Total Revenue</p>
                                <p id="totalRevenue" class="text-3xl font-bold">Rp 0</p>
                            </div>
                            <div class="bg-purple-400 bg-opacity-30 rounded-full p-3">
                                <i class="fas fa-money-bill-wave text-2xl"></i>
                            </div>
                        </div>
                    </div>
                    <button onclick="showSection('vendors')" class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl p-6 text-white hover:from-orange-600 hover:to-orange-700 transition-all transform hover:scale-105 w-full text-left">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100 text-sm font-medium">Vendor Aktif</p>
                                <p id="activeVendorsCount" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="bg-orange-400 bg-opacity-30 rounded-full p-3">
                                <i class="fas fa-store text-2xl"></i>
                            </div>
                        </div>
                        <div class="mt-2 text-orange-100 text-sm">
                            <i class="fas fa-eye mr-1"></i>Klik untuk melihat daftar
                        </div>
                    </button>
                </div>

                <!-- Filter Section -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Filter Pesanan</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter Vendor</label>
                            <select id="adminVendorFilter" onchange="applyAdminFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Semua Vendor</option>
                                <!-- Options will be loaded dynamically from database -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status Pesanan</label>
                            <select id="adminStatusFilter" onchange="applyAdminFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Semua Status</option>
                                <option value="pending">Pending</option>
                                <option value="processing">Processing</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai</label>
                            <input type="date" id="adminDateFrom" onchange="applyAdminFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Akhir</label>
                            <input type="date" id="adminDateTo" onchange="applyAdminFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <div class="text-sm text-gray-600 space-y-1">
                            <div>Menampilkan <span id="filteredOrdersCount">0</span> dari <span id="totalOrdersCount">0</span> pesanan</div>
                            <div class="flex space-x-4 text-xs">
                                <span>Items: <span id="filteredItemsCount" class="font-medium">0</span></span>
                                <span>Customer: <span id="filteredCustomersCount" class="font-medium">0</span></span>
                                <span>Total: <span id="filteredTotalAmount" class="font-medium">Rp 0</span></span>
                            </div>
                        </div>
                        <button onclick="resetAdminFilters()" class="text-blue-600 hover:text-blue-800 font-medium text-sm">
                            <i class="fas fa-refresh mr-1"></i>Reset Filter
                        </button>
                    </div>
                </div>

                <!-- All Orders Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Semua Pesanan</h3>
                    </div>
                    <div id="adminOrdersTable" class="overflow-x-auto">
                        <!-- All orders will be loaded here -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="mx-auto w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mb-4">
                        <i id="authIcon" class="fas fa-sign-in-alt text-white text-2xl"></i>
                    </div>
                    <h2 id="authTitle" class="text-2xl font-bold text-gray-900">Login</h2>
                </div>

                <form id="authForm" class="space-y-4">
                    <div id="nameField" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                        <input type="text" id="fullName" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="email" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="password" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    </div>

                    <button type="submit" id="authSubmit" 
                            class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-medium hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105">
                        Login
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <button id="authToggle" onclick="toggleAuthMode()" class="text-blue-600 hover:text-blue-800 font-medium">
                        Belum punya akun? Daftar di sini
                    </button>
                </div>

                <button onclick="hideAuthModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // KONFIGURASI SUPABASE (GANTI DENGAN KREDENSIAL ANDA)
        const SUPABASE_URL = "https://drfdjznyikcsercajaek.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyZmRqem55aWtjc2VyY2FqYWVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMTkyNTMsImV4cCI6MjA3NTU5NTI1M30.D2tbT9xTSblfG2Cvy4FEpZM5iqOr7FfMaIt6A-8Msuk";

        // Global variables
        let currentUser = null;
        let products = [];
        let orders = [];
        let cart = [];
        let currentTypeFilter = '';
        let supabaseClient = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() { // Menjadi async
            // Langsung inisialisasi Supabase dengan kredensial yang sudah ada di atas
            if (SUPABASE_URL !== "https://URL_PROYEK_ANDA.supabase.co" && SUPABASE_ANON_KEY !== "KUNCI_ANON_ANDA") {
                initializeSupabase(SUPABASE_URL, SUPABASE_ANON_KEY);
                await checkSession(); // Menunggu pengecekan sesi sebelum lanjut
            } else {
                // Tampilkan pesan jika kredensial belum diisi
                const grid = document.getElementById('productsGrid');
                if(grid){
                    grid.innerHTML = `
                        <div class="col-span-full text-center py-16">
                             <div class="bg-yellow-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-4">Konfigurasi Diperlukan</h3>
                            <p class="text-gray-600 max-w-md mx-auto">
                                Harap masukkan Supabase URL dan Anon Key Anda langsung di dalam kode file HTML (di dalam tag &lt;script&gt;).
                            </p>
                        </div>
                    `;
                }
            }
            setupEventListeners();
        });


        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('authForm').addEventListener('submit', handleAuth);
            document.getElementById('vendorForm').addEventListener('submit', handleAddVendor);
            document.getElementById('productForm').addEventListener('submit', handleAddProduct);
        }

        // Fungsi baru untuk memeriksa sesi saat halaman dimuat
        async function checkSession() {
            if (!supabaseClient) return;

            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                if (error) throw error;

                if (session) {
                    console.log('Sesi aktif ditemukan saat memuat halaman:', session.user);

                    // Ambil profil pengguna dari tabel 'users'
                    const { data: profile, error: profileError } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('id', session.user.id)
                        .single();

                    if (profileError) {
                        console.error('Gagal mengambil profil saat refresh:', profileError);
                        // Fallback jika profil tidak ada
                        currentUser = {
                            id: session.user.id,
                            email: session.user.email,
                            name: session.user.user_metadata?.full_name || session.user.email.split('@')[0],
                            role: 'customer',
                            vendor_category: null
                        };
                    } else {
                        currentUser = {
                            id: profile.id,
                            email: profile.email,
                            name: profile.full_name || profile.name,
                            role: profile.role,
                            vendor_category: profile.vendor_category
                        };
                    }
                    
                    console.log('Pengguna dipulihkan dari sesi:', currentUser);
                    updateUIForUser();
                } else {
                    console.log('Tidak ada sesi aktif saat memuat halaman.');
                }
            } catch(error) {
                console.error("Gagal memeriksa sesi:", error);
            }
        }

        function initializeSupabase(url, key) {
            try {
                // Initialize Supabase client
                supabaseClient = supabase.createClient(url, key);
                console.log('Supabase initialized.');
                
                // Load data from database
                loadDataFromDatabase();
                showNotification('Supabase terhubung dan data dimuat!', 'success');
            } catch (error) {
                console.error('Supabase initialization error:', error);
                showNotification('Gagal menginisialisasi Supabase', 'error');
            }
        }

        // Load all data from database
        async function loadDataFromDatabase() {
            if (!supabaseClient) return;
            
            try {
                // Load products first as other functions might depend on it
                await loadProducts();
                
                // Load other data
                await loadOrders();
                await loadUsers();
                
                // Generate filters from loaded data
                loadTypeFilters(); // For shopping page
                await loadAdminVendorFilters(); // For admin panels
                
                // Initial render
                renderProducts();
                
                console.log('Data loaded:', { products: products.length, orders: orders.length });
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Gagal memuat data dari database', 'error');
            }
        }

        // Load products from database
        async function loadProducts() {
            if (!supabaseClient) return;
            
            try {
                const { data, error } = await supabaseClient
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                products = data || [];
                console.log('Products loaded:', products.length);
            } catch (error) {
                console.error('Error loading products:', error);
                products = [];
            }
        }

        // Load orders from database
        async function loadOrders() {
            if (!supabaseClient) return;
            
            try {
                const { data, error } = await supabaseClient
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                orders = data || [];
                console.log('Orders loaded:', orders.length);
            } catch (error) {
                console.error('Error loading orders:', error);
                orders = [];
            }
        }

        // Load users from database
        async function loadUsers() {
            if (!supabaseClient) return;
            
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*');
                
                if (error) throw error;
                
                console.log('Users loaded:', data?.length || 0);
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load type filters from products for the shopping page
        function loadTypeFilters() {
            try {
                // Get unique, non-null, non-empty types from the global products array
                const uniqueTypes = [...new Set(products.map(p => p.type).filter(Boolean))];
                
                console.log('Active product types:', uniqueTypes);
                
                // Update shopping filter buttons
                updateShoppingTypeFilters(uniqueTypes);
                
            } catch (error) {
                console.error('Error loading type filters:', error);
                updateShoppingTypeFilters([]); // Show no filters on error
            }
        }

        // Load vendor filters from active vendors in database for admin panels
        async function loadAdminVendorFilters() {
            if (!supabaseClient) return;
            
            try {
                // Get unique vendor categories from active vendors
                const { data: vendors, error } = await supabaseClient
                    .from('users')
                    .select('vendor_category')
                    .eq('role', 'vendor')
                    .not('vendor_category', 'is', null);
                
                if (error) throw error;
                
                // Get unique categories
                const uniqueCategories = [...new Set(vendors.map(v => v.vendor_category).filter(Boolean))];
                
                console.log('Active vendor categories for Admin:', uniqueCategories);
                
                // Update admin filter dropdown
                updateAdminVendorFilters(uniqueCategories);
                
            } catch (error) {
                console.error('Error loading admin vendor filters:', error);
                // Fallback to default categories if database fails
                const defaultCategories = ['pin-kopi', 'satset-grill', 'ani-ksf'];
                updateAdminVendorFilters(defaultCategories);
            }
        }

        // Update shopping type filter buttons
        function updateShoppingTypeFilters(types) {
            const container = document.getElementById('typeFilterButtons');
            if (!container) return;
            
            // Keep the "Semua Tipe" button and add dynamic type buttons
            let buttonsHTML = `
                <button onclick="filterByType(event, '')" class="type-filter-btn bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-blue-700 transition-colors">
                    Semua Tipe
                </button>
            `;
            
            types.forEach(type => {
                const displayType = type.charAt(0).toUpperCase() + type.slice(1);
                buttonsHTML += `
                    <button onclick="filterByType(event, '${type}')" class="type-filter-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-medium border border-gray-300 hover:bg-gray-50 transition-colors">
                        ${displayType}
                    </button>
                `;
            });
            
            container.innerHTML = buttonsHTML;
        }

        // Update admin vendor filter dropdown
        function updateAdminVendorFilters(categories) {
            const select = document.getElementById('adminVendorFilter');
            if (!select) return;
            
            // Keep the "Semua Vendor" option and add dynamic vendor options
            let optionsHTML = '<option value="">Semua Vendor</option>';
            
            categories.forEach(category => {
                optionsHTML += `<option value="${category}">${getVendorName(category)}</option>`;
            });
            
            select.innerHTML = optionsHTML;
        }

        // Show auth modal
        function showAuthModal(mode) {
            const modal = document.getElementById('authModal');
            const title = document.getElementById('authTitle');
            const icon = document.getElementById('authIcon');
            const submit = document.getElementById('authSubmit');
            const toggle = document.getElementById('authToggle');
            const nameField = document.getElementById('nameField');
            
            if (mode === 'login') {
                title.textContent = 'Login';
                icon.className = 'fas fa-sign-in-alt text-white text-2xl';
                submit.textContent = 'Login';
                toggle.textContent = 'Belum punya akun? Daftar di sini';
                nameField.classList.add('hidden');
            } else {
                title.textContent = 'Daftar';
                icon.className = 'fas fa-user-plus text-white text-2xl';
                submit.textContent = 'Daftar';
                toggle.textContent = 'Sudah punya akun? Login di sini';
                nameField.classList.remove('hidden');
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Hide auth modal
        function hideAuthModal() {
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('authModal').classList.remove('flex');
            document.getElementById('authForm').reset();
        }

        // Toggle auth mode
        function toggleAuthMode() {
            const title = document.getElementById('authTitle').textContent;
            if (title === 'Login') {
                showAuthModal('register');
            } else {
                showAuthModal('login');
            }
        }

        // Handle authentication
        async function handleAuth(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const isLogin = document.getElementById('authTitle').textContent === 'Login';
            
            if (isLogin) {
                await handleLogin(email, password);
            } else {
                await handleRegister(email, password);
            }
        }

        // Handle login
        async function handleLogin(email, password) {
            if (!supabaseClient) {
                showNotification('Silakan setup koneksi Supabase terlebih dahulu', 'error');
                return;
            }

            try {
                // Try Supabase authentication
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                // Get user profile from database
                const { data: profile, error: profileError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('email', email)
                    .single();
                
                if (profileError) {
                    console.error('Profile error:', profileError);
                    // Fallback to basic user info
                    currentUser = {
                        id: data.user.id, // Use Supabase auth user ID
                        email: email,
                        name: data.user.user_metadata?.full_name || data.user.email?.split('@')[0] || 'User',
                        role: 'customer',
                        vendor_category: null
                    };
                } else {
                    currentUser = {
                        id: profile.id || data.user.id, // Use profile ID or auth ID
                        email: profile.email,
                        name: profile.full_name || profile.name || email.split('@')[0],
                        role: profile.role || 'customer',
                        vendor_category: profile.vendor_category
                    };
                }
                
                updateUIForUser();
                hideAuthModal();
                showNotification('Login berhasil!', 'success');
                
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Login gagal: ' + error.message, 'error');
            }
        }

        // Handle register
        async function handleRegister(email, password) {
            const fullName = document.getElementById('fullName').value;
            const role = 'customer'; // Semua user baru otomatis menjadi customer
            
            try {
                if (supabaseClient) {
                    console.log('Starting registration process for:', email);
                    
                    // Register with Supabase Auth
                    const { data, error } = await supabaseClient.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                full_name: fullName,
                                role: role
                            }
                        }
                    });
                    
                    if (error) {
                        console.error('Supabase auth signup error:', error);
                        throw error;
                    }
                    
                    console.log('Supabase auth signup successful:', data);
                    
                    // Check if user was created (some email providers require confirmation)
                    if (data.user) {
                        console.log('User created with ID:', data.user.id);
                        
                        // Save user profile to database with auth user ID
                        const userProfile = {
                            id: data.user.id, // Use Supabase auth user ID as primary key
                            email: email,
                            full_name: fullName,
                            role: role,
                            vendor_category: null,
                            phone_number: null,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        };
                        
                        console.log('Inserting user profile:', userProfile);
                        
                        const { data: profileData, error: profileError } = await supabaseClient
                            .from('users')
                            .insert([userProfile])
                            .select();
                        
                        if (profileError) {
                            console.error('Profile save error:', profileError);
                            
                            // Check if it's a duplicate key error (user already exists)
                            if (profileError.code === '23505') {
                                console.log('User profile already exists, updating instead...');
                                
                                // Try to update existing profile
                                const { data: updateData, error: updateError } = await supabaseClient
                                    .from('users')
                                    .update({
                                        full_name: fullName,
                                        updated_at: new Date().toISOString()
                                    })
                                    .eq('id', data.user.id)
                                    .select();
                                
                                if (updateError) {
                                    console.error('Profile update error:', updateError);
                                    showNotification('Registrasi berhasil tapi gagal menyimpan profil. Silakan login.', 'warning');
                                } else {
                                    console.log('Profile updated successfully:', updateData);
                                }
                            } else {
                                showNotification('Registrasi berhasil tapi gagal menyimpan profil: ' + profileError.message, 'warning');
                            }
                        } else {
                            console.log('Profile saved successfully:', profileData);
                        }
                        
                        // Set current user
                        currentUser = {
                            id: data.user.id,
                            email: email,
                            name: fullName,
                            role: role,
                            vendor_category: null
                        };
                        
                        // Check if email confirmation is required
                        if (data.session) {
                            // User is immediately logged in (email confirmation disabled)
                            updateUIForUser();
                            showNotification('Registrasi berhasil! Anda sudah login.', 'success');
                        } else {
                            // Email confirmation required
                            showNotification('Registrasi berhasil! Silakan cek email untuk verifikasi, lalu login.', 'success');
                        }
                        
                        hideAuthModal();
                        
                    } else {
                        console.log('User creation pending (email confirmation required)');
                        showNotification('Registrasi berhasil! Silakan cek email untuk verifikasi, lalu login.', 'success');
                        hideAuthModal();
                    }
                    
                } else {
                    showNotification('Silakan setup koneksi Supabase terlebih dahulu', 'error');
                    return;
                }
            } catch (error) {
                console.error('Register error:', error);
                
                let errorMessage = 'Registrasi gagal';
                if (error.message) {
                    errorMessage += ': ' + error.message;
                }
                
                // Handle specific Supabase errors
                if (error.message.includes('User already registered')) {
                    errorMessage = 'Email sudah terdaftar. Silakan login atau gunakan email lain.';
                } else if (error.message.includes('Invalid email')) {
                    errorMessage = 'Format email tidak valid.';
                } else if (error.message.includes('Password should be at least')) {
                    errorMessage = 'Password minimal 6 karakter.';
                }
                
                showNotification(errorMessage, 'error');
            }
        }

        // Update UI for authenticated user
        function updateUIForUser() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('userSection').classList.remove('hidden');
            document.getElementById('userName').textContent = `${currentUser.name} (${currentUser.role})`;
            
            if (currentUser.role === 'admin') {
                document.getElementById('adminNav').classList.remove('hidden');
            } else if (currentUser.role === 'vendor') {
                document.getElementById('vendorNav').classList.remove('hidden');
            }
            
            updateCartBadge();
        }

        // Logout
        function logout() {
            currentUser = null;
            cart = [];
            
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('userSection').classList.add('hidden');
            document.getElementById('adminNav').classList.add('hidden');
            document.getElementById('vendorNav').classList.add('hidden');
            
            showSection('shopping');
            updateCartBadge();
            showNotification('Logout berhasil!', 'success');
        }

        // Show section
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(s => s.classList.add('hidden'));
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', 'bg-blue-50');
                btn.classList.add('text-gray-600');
            });
            
            // Show selected section
            document.getElementById(section + 'Section').classList.remove('hidden');
            
            // Highlight the active navigation icon/button
            if (document.getElementById(section + 'Nav')) {
                const navButton = document.getElementById(section + 'Nav');
                navButton.classList.remove('text-gray-600');
                
                // For icon buttons (admin/vendor), apply a background color for active state
                if (section === 'admin' || section === 'vendor') {
                    navButton.classList.add('text-blue-600', 'bg-blue-50');
                } else {
                    // Fallback for any future text-based nav buttons
                    navButton.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                }
            }
            
            // Load section-specific data
            if (section === 'cart') {
                renderCart();
            } else if (section === 'admin') {
                loadAdminData();
            } else if (section === 'vendor') {
                loadVendorData();
            } else if (section === 'vendorProducts') {
                loadVendorProducts();
            } else if (section === 'orders') {
                loadCustomerOrders();
            } else if (section === 'vendors') {
                loadVendorsManagement();
            } else if (section === 'adminProducts') {
                loadAdminProducts();
            }
        }

        // Load customer orders
        function loadCustomerOrders() {
            if (!currentUser) return;
            
            console.log('Loading customer orders for:', currentUser);
            console.log('All orders:', orders);
            
            // Filter orders by current user - check multiple fields for compatibility
            const customerOrders = orders.filter(order => {
                const matchesUserId = order.user_id === currentUser.id;
                const matchesEmail = order.customer_email === currentUser.email;
                
                console.log('Checking order:', order.id, {
                    orderUserId: order.user_id,
                    currentUserId: currentUser.id,
                    orderEmail: order.customer_email,
                    currentEmail: currentUser.email,
                    matchesUserId,
                    matchesEmail
                });
                
                return matchesUserId || matchesEmail;
            });
            
            console.log('Filtered customer orders:', customerOrders);
            renderCustomerOrders(customerOrders);
        }

        // Render customer orders
        function renderCustomerOrders(customerOrders) {
            const container = document.getElementById('customerOrdersContent');
            
            if (!customerOrders || customerOrders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16">
                        <div class="bg-gray-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-receipt text-gray-400 text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">Belum Ada Pesanan</h3>
                        <p class="text-gray-600 mb-6 max-w-md mx-auto">
                            Anda belum pernah melakukan pemesanan. Mulai berbelanja sekarang!
                        </p>
                        <button onclick="showSection('shopping')" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors transform hover:scale-105">
                            <i class="fas fa-shopping-bag mr-2"></i>Mulai Belanja
                        </button>
                    </div>
                `;
                return;
            }
            
            // Sort orders by date (newest first)
            customerOrders.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            container.innerHTML = `
                <div class="space-y-6">
                    ${customerOrders.map(order => {
                        // Ensure order.items exists and is an array
                        const orderItems = order.items || [];
                        
                        return `
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                            <div class="p-6 border-b border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900">Pesanan #${order.id}</h3>
                                        <p class="text-sm text-gray-500 mt-1">
                                            ${new Date(order.created_at).toLocaleDateString('id-ID', {
                                                weekday: 'long',
                                                year: 'numeric',
                                                month: 'long',
                                                day: 'numeric',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            })}
                                        </p>
                                    </div>
                                    <div class="text-right">
                                        <span class="px-3 py-1 rounded-full text-sm font-medium ${getOrderStatusClass(order.status || 'pending')}">
                                            ${getOrderStatusText(order.status || 'pending')}
                                        </span>
                                        <p class="text-2xl font-bold text-blue-600 mt-2">Rp ${formatPrice(order.total || order.total_amount || 0)}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="p-6">
                                <h4 class="font-medium text-gray-900 mb-4">Item Pesanan:</h4>
                                <div class="space-y-3">
                                    ${orderItems.length > 0 ? orderItems.map(item => `
                                        <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0">
                                            <div class="flex-1">
                                                <p class="font-medium text-gray-900">${item.product_name || 'Produk'}</p>
                                                <p class="text-sm text-gray-500">${getVendorName(item.category || '')} â€¢ Qty: ${item.quantity || 1}</p>
                                            </div>
                                            <p class="font-medium text-gray-900">Rp ${formatPrice((item.price || 0) * (item.quantity || 1))}</p>
                                        </div>
                                    `).join('') : '<p class="text-gray-500 text-sm">Tidak ada item</p>'}
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-200">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm text-gray-600">Metode Pembayaran:</span>
                                        <span class="text-sm font-medium text-gray-900">${getPaymentMethodText(order.payment_method || 'cash')}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium text-gray-900">Total Pesanan:</span>
                                        <span class="text-xl font-bold text-blue-600">Rp ${formatPrice(order.total || order.total_amount || 0)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Load vendor data - PESANAN DARI PRODUK VENDOR INI
        function loadVendorData() {
            if (!currentUser || currentUser.role !== 'vendor') return;
            
            // Set vendor category name
            document.getElementById('vendorCategoryName').textContent = getVendorName(currentUser.vendor_category);
            
            // Filter products by vendor category
            const vendorProducts = products.filter(p => p.category === currentUser.vendor_category);
            
            // Filter orders that contain products from this vendor
            const vendorOrders = orders.filter(order => 
                order.items && order.items.some(item => item.category === currentUser.vendor_category)
            );
            
            // Calculate stats
            const totalProducts = vendorProducts.length;
            const totalOrders = vendorOrders.length;
            const totalRevenue = vendorOrders.reduce((sum, order) => {
                // Only count revenue from this vendor's products
                const vendorItems = (order.items || []).filter(item => item.category === currentUser.vendor_category);
                return sum + vendorItems.reduce((itemSum, item) => itemSum + (item.price * item.quantity), 0);
            }, 0);
            
            // Update stats
            document.getElementById('vendorTotalProducts').textContent = totalProducts;
            document.getElementById('vendorTotalOrders').textContent = totalOrders;
            document.getElementById('vendorTotalRevenue').textContent = 'Rp ' + formatPrice(totalRevenue);
            
            // Render vendor orders
            renderVendorOrders(vendorOrders);
        }

        // Render vendor orders - MENAMPILKAN PESANAN CUSTOMER DENGAN DETAIL LENGKAP
        function renderVendorOrders(vendorOrders) {
            const tableContainer = document.getElementById('vendorOrdersTable');
            
            if (!vendorOrders || vendorOrders.length === 0) {
                tableContainer.innerHTML = `
                    <div class="p-8 text-center">
                        <i class="fas fa-receipt text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-500">Belum ada pesanan untuk produk Anda</p>
                    </div>
                `;
                return;
            }
            
            // Sort orders by date (newest first)
            vendorOrders.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            let tableRows = '';
            
            vendorOrders.forEach(order => {
                // Filter hanya item dari vendor ini
                const vendorItems = (order.items || []).filter(item => item.category === currentUser.vendor_category);
                const vendorSubtotal = vendorItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                // Group items by order (one row per order, showing all vendor items)
                tableRows += `
                    <tr class="hover:bg-gray-50">
                        <td class="py-4 px-6 font-mono text-sm">#${order.id}</td>
                        <td class="py-4 px-6">
                            <div>
                                <p class="font-medium text-gray-900">${order.customer_name || 'Customer'}</p>
                                <p class="text-sm text-gray-500">${order.customer_email || 'No email'}</p>
                                <p class="text-xs text-gray-400 mt-1">
                                    <i class="fas fa-clock mr-1"></i>
                                    ${new Date(order.created_at).toLocaleDateString('id-ID', {
                                        day: 'numeric',
                                        month: 'short',
                                        year: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    })}
                                </p>
                            </div>
                        </td>
                        <td class="py-4 px-6">
                            <div class="space-y-1">
                                ${vendorItems.map(item => `
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium text-gray-900">${item.product_name}</span>
                                        <span class="text-sm text-gray-500">Ã—${item.quantity}</span>
                                    </div>
                                    <div class="text-sm text-gray-500">Rp ${formatPrice(item.price)} per item</div>
                                `).join('')}
                            </div>
                        </td>
                        <td class="py-4 px-6">
                            <div class="text-right">
                                <p class="font-bold text-gray-900">Rp ${formatPrice(vendorSubtotal)}</p>
                                <p class="text-xs text-gray-500">dari produk saya</p>
                                <p class="text-xs text-gray-400">Total pesanan: Rp ${formatPrice(order.total || order.total_amount || 0)}</p>
                            </div>
                        </td>
                        <td class="py-4 px-6">
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${getOrderStatusClass(order.status || 'pending')}">
                                ${getOrderStatusText(order.status || 'pending')}
                            </span>
                        </td>
                        <td class="py-4 px-6">
                            <div class="flex flex-col space-y-1">
                                <button onclick="updateOrderStatus('${order.id}', 'processing')" 
                                        class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200 transition-colors">
                                    <i class="fas fa-play mr-1"></i>Proses
                                </button>
                                <button onclick="updateOrderStatus('${order.id}', 'delivered')" 
                                        class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded hover:bg-green-200 transition-colors">
                                    <i class="fas fa-check mr-1"></i>Selesai
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            const table = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-left py-4 px-6 font-medium text-gray-700">ID Pesanan</th>
                            <th class="text-left py-4 px-6 font-medium text-gray-700">Detail Customer</th>
                            <th class="text-left py-4 px-6 font-medium text-gray-700">Produk Saya</th>
                            <th class="text-left py-4 px-6 font-medium text-gray-700">Pendapatan</th>
                            <th class="text-left py-4 px-6 font-medium text-gray-700">Status</th>
                            <th class="text-left py-4 px-6 font-medium text-gray-700">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${tableRows}
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = table;
        }

        // Load admin data
        function loadAdminData() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            // Calculate stats based on ALL data (not filtered)
            const totalProducts = products.length;
            const totalOrders = orders.length;
            const totalRevenue = orders.reduce((sum, order) => sum + (order.total || order.total_amount || 0), 0);
            
            // Update stats
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('totalRevenue').textContent = 'Rp ' + formatPrice(totalRevenue);
            
            // Render all orders
            renderAdminOrders();
        }

        // Apply admin filters
        function applyAdminFilters() {
            renderAdminOrders();
        }

        // Reset admin filters
        function resetAdminFilters() {
            document.getElementById('adminVendorFilter').value = '';
            document.getElementById('adminStatusFilter').value = '';
            document.getElementById('adminDateFrom').value = '';
            document.getElementById('adminDateTo').value = '';
            renderAdminOrders();
        }

        // Calculate filtered statistics
        function calculateFilteredStats(filteredOrders) {
            let totalItems = 0;
            let totalAmount = 0;
            const uniqueCustomers = new Set();
            const vendorFilter = document.getElementById('adminVendorFilter')?.value || '';
            
            filteredOrders.forEach(order => {
                const orderItems = order.items || [];
                
                if (vendorFilter) {
                    // If vendor filter is active, only count items from that vendor
                    const vendorItems = orderItems.filter(item => item.category === vendorFilter);
                    
                    // Count only vendor items
                    totalItems += vendorItems.reduce((sum, item) => sum + (item.quantity || 1), 0);
                    
                    // Sum only vendor items amount
                    totalAmount += vendorItems.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);
                } else {
                    // No vendor filter, count all items
                    totalItems += orderItems.reduce((sum, item) => sum + (item.quantity || 1), 0);
                    totalAmount += order.total || order.total_amount || 0;
                }
                
                // Track unique customers
                if (order.customer_email) {
                    uniqueCustomers.add(order.customer_email);
                } else if (order.user_id) {
                    uniqueCustomers.add(order.user_id);
                }
            });
            
            return {
                totalItems: totalItems,
                uniqueCustomers: uniqueCustomers.size,
                totalAmount: totalAmount
            };
        }

        // Get filtered orders for admin
        function getFilteredAdminOrders() {
            const vendorFilter = document.getElementById('adminVendorFilter')?.value || '';
            const statusFilter = document.getElementById('adminStatusFilter')?.value || '';
            const dateFrom = document.getElementById('adminDateFrom')?.value || '';
            const dateTo = document.getElementById('adminDateTo')?.value || '';
            
            let filteredOrders = [...orders];
            
            // Filter by vendor
            if (vendorFilter) {
                filteredOrders = filteredOrders.filter(order => {
                    const orderItems = order.items || [];
                    return orderItems.some(item => item.category === vendorFilter);
                });
            }
            
            // Filter by status
            if (statusFilter) {
                filteredOrders = filteredOrders.filter(order => 
                    (order.status || 'pending') === statusFilter
                );
            }
            
            // Filter by date range
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                fromDate.setHours(0, 0, 0, 0);
                filteredOrders = filteredOrders.filter(order => 
                    new Date(order.created_at) >= fromDate
                );
            }
            
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                filteredOrders = filteredOrders.filter(order => 
                    new Date(order.created_at) <= toDate
                );
            }
            
            return filteredOrders;
        }

        // Render admin orders
        function renderAdminOrders() {
            const tableContainer = document.getElementById('adminOrdersTable');
            
            if (!orders || orders.length === 0) {
                tableContainer.innerHTML = `
                    <div class="p-8 text-center">
                        <i class="fas fa-shopping-cart text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-500">Belum ada pesanan</p>
                    </div>
                `;
                
                // Update counters
                if (document.getElementById('filteredOrdersCount')) {
                    document.getElementById('filteredOrdersCount').textContent = '0';
                    document.getElementById('totalOrdersCount').textContent = '0';
                    document.getElementById('filteredItemsCount').textContent = '0';
                    document.getElementById('filteredCustomersCount').textContent = '0';
                    document.getElementById('filteredTotalAmount').textContent = 'Rp 0';
                }
                return;
            }
            
            // Get filtered orders
            const filteredOrders = getFilteredAdminOrders();
            
            // Calculate filtered statistics
            const filteredStats = calculateFilteredStats(filteredOrders);
            
            // Update counters
            if (document.getElementById('filteredOrdersCount')) {
                document.getElementById('filteredOrdersCount').textContent = filteredOrders.length;
                document.getElementById('totalOrdersCount').textContent = orders.length;
                document.getElementById('filteredItemsCount').textContent = filteredStats.totalItems;
                document.getElementById('filteredCustomersCount').textContent = filteredStats.uniqueCustomers;
                document.getElementById('filteredTotalAmount').textContent = 'Rp ' + formatPrice(filteredStats.totalAmount);
            }
            
            if (filteredOrders.length === 0) {
                tableContainer.innerHTML = `
                    <div class="p-8 text-center">
                        <i class="fas fa-filter text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-500">Tidak ada pesanan yang sesuai dengan filter</p>
                        <button onclick="resetAdminFilters()" class="mt-4 text-blue-600 hover:text-blue-800 font-medium">
                            <i class="fas fa-refresh mr-2"></i>Reset Filter
                        </button>
                    </div>
                `;
                
                // Update counters for empty results
                if (document.getElementById('filteredOrdersCount')) {
                    document.getElementById('filteredOrdersCount').textContent = '0';
                    document.getElementById('filteredItemsCount').textContent = '0';
                    document.getElementById('filteredCustomersCount').textContent = '0';
                    document.getElementById('filteredTotalAmount').textContent = 'Rp 0';
                }
                return;
            }
            
            // Sort orders by date (newest first)
            const sortedOrders = filteredOrders.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            const table = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="text-left py-4 px-6 font-medium text-gray-700">ID Pesanan</th>
                            <th class="text-left py-4 px-6 font-medium text-gray-700">Customer</th>
                            <th class="text-left py-4 px-6 font-medium text-gray-700">Items</th>
                            <th class="text-left py-4 px-6 font-medium text-gray-700">Total</th>
                            <th class="text-left py-4 px-6 font-medium text-gray-700">Status</th>
                            <th class="text-left py-4 px-6 font-medium text-gray-700">Payment Method</th>
                            <th class="text-left py-4 px-6 font-medium text-gray-700">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${sortedOrders.map(order => {
                            // Ensure order.items exists and is an array
                            const orderItems = order.items || [];
                            
                            return `
                            <tr class="hover:bg-gray-50">
                                <td class="py-4 px-6 font-mono text-sm">#${order.id}</td>
                                <td class="py-4 px-6">
                                    <div>
                                        <p class="font-medium text-gray-900">${order.customer_name || 'Customer'}</p>
                                        <p class="text-sm text-gray-500">${order.customer_email || 'No email'}</p>
                                        <p class="text-xs text-gray-400 mt-1">
                                            <i class="fas fa-clock mr-1"></i>
                                            ${new Date(order.created_at).toLocaleDateString('id-ID', {
                                                day: 'numeric',
                                                month: 'short',
                                                year: 'numeric',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            })}
                                        </p>
                                    </div>
                                </td>
                                <td class="py-4 px-6">
                                    <div class="text-sm space-y-1">
                                        ${orderItems.length > 0 ? orderItems.map(item => `
                                            <div class="flex justify-between items-center">
                                                <span class="font-medium text-gray-900">${item.product_name || 'Produk'}</span>
                                                <span class="text-gray-500">Ã—${item.quantity || 1}</span>
                                            </div>
                                            <div class="text-xs text-gray-500">${getVendorName(item.category || '')} â€¢ Rp ${formatPrice((item.price || 0) * (item.quantity || 1))}</div>
                                        `).join('') : '<span class="text-gray-500">Tidak ada item</span>'}
                                    </div>
                                </td>
                                <td class="py-4 px-6 font-medium text-gray-900">Rp ${formatPrice(order.total || order.total_amount || 0)}</td>
                                <td class="py-4 px-6">
                                    <span class="px-3 py-1 rounded-full text-sm font-medium ${getOrderStatusClass(order.status || 'pending')}">
                                        ${getOrderStatusText(order.status || 'pending')}
                                    </span>
                                </td>
                                <td class="py-4 px-6 text-sm text-gray-600">
                                    ${getPaymentMethodText(order.payment_method || 'cash')}
                                </td>
                                <td class="py-4 px-6">
                                    <div class="flex flex-col space-y-1">
                                        <button onclick="updateOrderStatusAdmin('${order.id}', 'processing')" 
                                                class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200 transition-colors">
                                            <i class="fas fa-play mr-1"></i>Proses
                                        </button>
                                        <button onclick="updateOrderStatusAdmin('${order.id}', 'delivered')" 
                                                class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded hover:bg-green-200 transition-colors">
                                            <i class="fas fa-check mr-1"></i>Selesai
                                        </button>
                                        <button onclick="updateOrderStatusAdmin('${order.id}', 'cancelled')" 
                                                class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded hover:bg-red-200 transition-colors">
                                            <i class="fas fa-times mr-1"></i>Batal
                                        </button>
                                        <button onclick="printOrder('${order.id}')"
                                                class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded hover:bg-gray-200 transition-colors mt-1">
                                            <i class="fas fa-print mr-1"></i>Cetak
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = table;
        }

        // Get order status class
        function getOrderStatusClass(status) {
            switch (status) {
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'processing': return 'bg-blue-100 text-blue-800';
                case 'delivered': return 'bg-green-100 text-green-800';
                case 'cancelled': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Get order status text
        function getOrderStatusText(status) {
            switch (status) {
                case 'pending': return 'Pending';
                case 'processing': return 'Processing';
                case 'delivered': return 'Delivered';
                case 'cancelled': return 'Cancelled';
                default: return status;
            }
        }

        // Get payment method text
        function getPaymentMethodText(method) {
            switch (method) {
                case 'cash': return 'Tunai';
                case 'transfer': return 'Transfer Bank';
                case 'qris': return 'QRIS';
                default: return 'Tunai';
            }
        }

        // Get vendor name - converts category to display name
        function getVendorName(category) {
            if (!category) return 'Unknown Vendor';
            
            // Predefined vendor names
            const vendorNames = {
                'pin-kopi': 'Pin Kopi',
                'satset-grill': 'SatSet Grill',
                'ani-ksf': 'Ani KSF'
            };
            
            // If it's a predefined vendor, return the display name
            if (vendorNames[category]) {
                return vendorNames[category];
            }
            
            // For custom categories, convert kebab-case to Title Case
            // Example: 'toko-elektronik' becomes 'Toko Elektronik'
            return category
                .split('-')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // Format price
        function formatPrice(price) {
            return new Intl.NumberFormat('id-ID').format(price);
        }

        // Filter by type
        function filterByType(event, type) {
            currentTypeFilter = type;
            
            // Update filter buttons
            document.querySelectorAll('.type-filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300');
            });
            
            if(event && event.target) {
                event.target.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300');
                event.target.classList.add('bg-blue-600', 'text-white');
            }
            
            renderProducts();
        }

        // Render products
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            
            // Check if Supabase is not configured yet in the hardcoded constants
            if (!supabaseClient) {
                 if (SUPABASE_URL === "https://URL_PROYEK_ANDA.supabase.co" || SUPABASE_ANON_KEY === "KUNCI_ANON_ANDA") {
                    // This will be handled by the DOMContentLoaded listener's else block
                    return;
                }
                // If credentials are set but initialization hasn't happened yet, show a loading state or just wait.
                // The current structure calls renderProducts before initializeSupabase, so we prevent it from showing "No products" prematurely.
                grid.innerHTML = `<div class="col-span-full text-center py-16"><p class="text-gray-500">Memuat produk...</p></div>`
                return;
            }
            
            // Filter products by type if needed
            let filteredProducts = products;
            if (currentTypeFilter) {
                filteredProducts = products.filter(p => (p.type || '').toLowerCase() === currentTypeFilter.toLowerCase());
            }
            
            // Check if no products available
            if (filteredProducts.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-16">
                        <div class="bg-gray-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-box-open text-gray-400 text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">Belum Ada Produk</h3>
                        <p class="text-gray-600 mb-6 max-w-md mx-auto">
                            ${currentTypeFilter ? `Tidak ada produk untuk tipe "${currentTypeFilter}".` : 'Database terhubung tapi belum ada produk. Tambahkan produk melalui panel vendor.'}
                        </p>
                        ${!currentTypeFilter ? `
                            <button onclick="loadDataFromDatabase()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                                <i class="fas fa-refresh mr-2"></i>Refresh
                            </button>
                        ` : ''}
                    </div>
                `;
                return;
            }
            
            // Render products
            grid.innerHTML = filteredProducts.map(product => `
                <div class="vendor-card bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="aspect-w-16 aspect-h-12 bg-gray-200">
                        <img src="${product.image_url || 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400'}" 
                             alt="${product.name}" 
                             class="w-full h-48 object-cover"
                             onerror="this.src='https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400'">
                    </div>
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                                ${product.type ? (product.type.charAt(0).toUpperCase() + product.type.slice(1)) : 'Umum'}
                            </span>
                            <span class="text-sm text-gray-500">Stok: ${product.stock || 0}</span>
                        </div>
                        <h3 class="font-semibold text-gray-900 mb-2">${product.name}</h3>
                        <p class="text-gray-600 text-sm mb-4 line-clamp-2">${product.description || 'Tidak ada deskripsi'}</p>
                        <div class="flex items-center justify-between">
                            <span class="text-2xl font-bold text-blue-600">Rp ${formatPrice(product.price || 0)}</span>
                            <button onclick="addToCart(${product.id})" 
                                    class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-4 py-2 rounded-lg font-medium hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105 ${(product.stock || 0) === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                                    ${(product.stock || 0) === 0 ? 'disabled' : ''}>
                                <i class="fas fa-cart-plus mr-2"></i>
                                ${(product.stock || 0) === 0 ? 'Habis' : 'Tambah'}
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Add to cart
        function addToCart(productId) {
            if (!currentUser) {
                showAuthModal('login');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product || product.stock === 0) return;
            
            const existingItem = cart.find(item => item.product_id === productId);
            
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity += 1;
                } else {
                    showNotification('Stok tidak mencukupi', 'error');
                    return;
                }
            } else {
                cart.push({
                    product_id: productId,
                    product: product,
                    quantity: 1,
                    price: product.price
                });
            }
            
            updateCartBadge();
            showNotification(`${product.name} ditambahkan ke keranjang`, 'success');
        }

        // Update cart badge
        function updateCartBadge() {
            const badge = document.getElementById('cartBadge');
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            
            if (totalItems > 0) {
                badge.textContent = totalItems;
                badge.classList.remove('hidden');
                badge.classList.add('cart-badge');
            } else {
                badge.classList.add('hidden');
            }
        }

        // Render cart
        function renderCart() {
            const container = document.getElementById('cartContent');
            
            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-shopping-cart text-gray-400 text-6xl mb-4"></i>
                        <p class="text-gray-500 text-lg mb-4">Keranjang belanja kosong</p>
                        <button onclick="showSection('shopping')" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                            Mulai Belanja
                        </button>
                    </div>
                `;
                return;
            }
            
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            container.innerHTML = `
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-6">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Item Keranjang</h3>
                        <div class="space-y-4">
                            ${cart.map(item => `
                                <div class="flex items-center space-x-4 p-4 border border-gray-200 rounded-lg">
                                    <img src="${item.product.image_url}" 
                                         alt="${item.product.name}" 
                                         class="w-16 h-16 object-cover rounded-lg"
                                         onerror="this.src='https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400'">
                                    <div class="flex-1">
                                        <h4 class="font-medium text-gray-900">${item.product.name}</h4>
                                        <p class="text-sm text-gray-500">${getVendorName(item.product.category)}</p>
                                        <p class="text-lg font-semibold text-blue-600">Rp ${formatPrice(item.price)}</p>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <button onclick="updateCartQuantity(${item.product_id}, ${item.quantity - 1})" 
                                                class="w-8 h-8 bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition-colors">
                                            <i class="fas fa-minus text-xs"></i>
                                        </button>
                                        <span class="w-8 text-center font-medium">${item.quantity}</span>
                                        <button onclick="updateCartQuantity(${item.product_id}, ${item.quantity + 1})" 
                                                class="w-8 h-8 bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition-colors">
                                            <i class="fas fa-plus text-xs"></i>
                                        </button>
                                    </div>
                                    <button onclick="removeFromCart(${item.product_id})" 
                                            class="text-red-600 hover:text-red-800 transition-colors">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-lg font-semibold text-gray-900">Total</span>
                        <span class="text-2xl font-bold text-blue-600">Rp ${formatPrice(total)}</span>
                    </div>
                    
                    <!-- Payment Method Selection -->
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Pilih Metode Pembayaran</h4>
                        <div class="space-y-3">
                            <label class="flex items-center p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                                <input type="radio" name="paymentMethod" value="cash" class="mr-3 text-blue-600" onchange="updatePaymentInfo()">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-money-bill-wave text-green-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">Tunai</p>
                                        <p class="text-sm text-gray-500">Bayar langsung saat pengambilan</p>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="flex items-center p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                                <input type="radio" name="paymentMethod" value="transfer" class="mr-3 text-blue-600" onchange="updatePaymentInfo()">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-university text-blue-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">Transfer Bank</p>
                                        <p class="text-sm text-gray-500">Transfer ke rekening bank</p>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="flex items-center p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                                <input type="radio" name="paymentMethod" value="qris" class="mr-3 text-blue-600" onchange="updatePaymentInfo()">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-qrcode text-purple-600"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">QRIS</p>
                                        <p class="text-sm text-gray-500">Scan QR Code untuk pembayaran</p>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Payment Information -->
                    <div id="paymentInfo" class="hidden mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <!-- Payment details will be shown here -->
                    </div>
                    
                    <button onclick="checkout()" id="checkoutBtn"
                            class="w-full bg-gray-400 text-white py-3 rounded-lg font-medium cursor-not-allowed" disabled>
                        <i class="fas fa-credit-card mr-2"></i>Pilih Metode Pembayaran
                    </button>
                </div>
            `;
        }

        // Update cart quantity
        function updateCartQuantity(productId, newQuantity) {
            if (newQuantity <= 0) {
                removeFromCart(productId);
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (newQuantity > product.stock) {
                showNotification('Stok tidak mencukupi', 'error');
                return;
            }
            
            const item = cart.find(item => item.product_id === productId);
            if (item) {
                item.quantity = newQuantity;
                updateCartBadge();
                renderCart();
            }
        }

        // Remove from cart
        function removeFromCart(productId) {
            cart = cart.filter(item => item.product_id !== productId);
            updateCartBadge();
            renderCart();
            showNotification('Item dihapus dari keranjang', 'success');
        }

        // Update payment information based on selected method
        function updatePaymentInfo() {
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
            const paymentInfo = document.getElementById('paymentInfo');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (!selectedMethod) {
                paymentInfo.classList.add('hidden');
                checkoutBtn.disabled = true;
                checkoutBtn.className = 'w-full bg-gray-400 text-white py-3 rounded-lg font-medium cursor-not-allowed';
                checkoutBtn.innerHTML = '<i class="fas fa-credit-card mr-2"></i>Pilih Metode Pembayaran';
                return;
            }
            
            // Enable checkout button
            checkoutBtn.disabled = false;
            checkoutBtn.className = 'w-full bg-gradient-to-r from-green-500 to-blue-600 text-white py-3 rounded-lg font-medium hover:from-green-600 hover:to-blue-700 transition-all transform hover:scale-105';
            checkoutBtn.innerHTML = '<i class="fas fa-credit-card mr-2"></i>Checkout Sekarang';
            
            const method = selectedMethod.value;
            
            if (method === 'cash') {
                // Hide payment info for cash
                paymentInfo.classList.add('hidden');
            } else if (method === 'transfer') {
                // Show bank transfer info
                paymentInfo.classList.remove('hidden');
                paymentInfo.innerHTML = `
                    <div class="flex items-start">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-4 flex-shrink-0">
                            <i class="fas fa-university text-blue-600"></i>
                        </div>
                        <div class="flex-1">
                            <h5 class="font-semibold text-blue-900 mb-3">Informasi Transfer Bank</h5>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Bank:</span>
                                    <span class="font-medium text-gray-900">Bank Syariah Indonesia (BSI)</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">No. Rekening:</span>
                                    <span class="font-medium text-gray-900 font-mono">7292519928</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Atas Nama:</span>
                                    <span class="font-medium text-gray-900">Irianti Mega</span>
                                </div>
                            </div>
                            <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <p class="text-xs text-yellow-800">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Silakan transfer sesuai total pembayaran dan kirim bukti transfer untuk konfirmasi pesanan.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (method === 'qris') {
                // Show QRIS info
                paymentInfo.classList.remove('hidden');
                paymentInfo.innerHTML = `
                    <div class="flex items-start">
                        <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mr-4 flex-shrink-0">
                            <i class="fas fa-qrcode text-purple-600"></i>
                        </div>
                        <div class="flex-1">
                            <h5 class="font-semibold text-purple-900 mb-3">Pembayaran QRIS</h5>
                            <div class="text-center">
                                <div class="w-48 h-48 bg-white border-2 border-gray-300 rounded-lg mx-auto mb-3 overflow-hidden">
                                    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgCasssXDfDwY5JY1YgVuuHIoSk0Xl0PPy5xdfl3cFsRnYC0euhgylGONrXhl2L653RI3IKl5faxwfovcpXqi7hwSOOiytvZO7-rwtKvBOuB1BG0AIVEqatnKRPjJ5vbJHIkRM76OHj4FpKhSvG-XMAXVhnWRuQFk8m0GU0WDmE7g531Ge5MzyldTxjdIs/s375/Qris%20Masakin.jpg" 
                                         alt="QRIS Masakin Aja" 
                                         class="w-full h-full object-cover"
                                         onerror="this.parentElement.innerHTML='<i class=\\'fas fa-qrcode text-gray-400 text-4xl\\'></i>'">
                                </div>
                                <p class="text-sm text-gray-600 mb-2">Scan QR Code dengan aplikasi pembayaran Anda</p>
                                <p class="text-xs text-gray-500">Mendukung: GoPay, OVO, DANA, ShopeePay, dll</p>
                            </div>
                            <div class="mt-3 p-3 bg-purple-50 border border-purple-200 rounded-lg">
                                <p class="text-xs text-purple-800">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    QR Code akan ditampilkan setelah konfirmasi pesanan.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Checkout
        async function checkout() {
            if (cart.length === 0) return;
            
            // Check if payment method is selected
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
            if (!selectedMethod) {
                showNotification('Silakan pilih metode pembayaran terlebih dahulu', 'error');
                return;
            }
            
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // Create new order with proper database schema
            const newOrder = {
                user_id: currentUser.id || `demo-${Date.now()}`, // Ensure valid user_id
                customer_name: currentUser.name,
                customer_email: currentUser.email,
                items: cart.map(item => ({
                    product_id: item.product_id,
                    product_name: item.product.name,
                    category: item.product.category,
                    quantity: item.quantity,
                    price: item.price
                })),
                total: total,
                total_amount: total, // Add total_amount field for database
                payment_method: selectedMethod.value, // Save selected payment method
                status: 'pending',
                created_at: new Date().toISOString()
            };
            
            console.log('Creating order:', newOrder);
            console.log('Current user:', currentUser);
            
            try {
                // Save order to database if Supabase is connected
                if (supabaseClient) {
                    const { data, error } = await supabaseClient
                        .from('orders')
                        .insert([newOrder])
                        .select();
                    
                    if (error) throw error;
                    
                    // Update local orders array with the returned data (includes database ID)
                    if (data && data.length > 0) {
                        orders.push(data[0]);
                        console.log('Order saved to database:', data[0]);
                    }
                    
                    // Update product stock in database
                    for (const item of cart) {
                        const product = products.find(p => p.id === item.product_id);
                        if (product) {
                            const newStock = product.stock - item.quantity;
                            
                            const { error: stockError } = await supabaseClient
                                .from('products')
                                .update({ stock: newStock })
                                .eq('id', item.product_id);
                            
                            if (stockError) {
                                console.error('Error updating stock:', stockError);
                            } else {
                                product.stock = newStock;
                            }
                        }
                    }
                } else {
                    showNotification('Koneksi database tidak tersedia. Silakan setup Supabase terlebih dahulu.', 'error');
                    return;
                }
                
                // Clear cart
                cart = [];
                updateCartBadge();
                
                showNotification('Pesanan berhasil dibuat! Cek halaman "Pesanan Saya"', 'success');
                showSection('shopping');
                renderProducts(); // Refresh products to show updated stock
                
            } catch (error) {
                console.error('Checkout error:', error);
                showNotification('Gagal membuat pesanan: ' + error.message, 'error');
            }
        }

        // Update order status (for vendors)
        async function updateOrderStatus(orderId, newStatus) {
            if (!currentUser || currentUser.role !== 'vendor') {
                showNotification('Hanya vendor yang dapat mengubah status pesanan', 'error');
                return;
            }
            
            try {
                // Find the order
                const order = orders.find(o => o.id == orderId);
                if (!order) {
                    showNotification('Pesanan tidak ditemukan', 'error');
                    return;
                }
                
                // Check if this vendor has products in this order
                const hasVendorProducts = (order.items || []).some(item => item.category === currentUser.vendor_category);
                if (!hasVendorProducts) {
                    showNotification('Anda tidak memiliki produk dalam pesanan ini', 'error');
                    return;
                }
                
                // Update status in database if Supabase is connected
                if (supabaseClient) {
                    const { error } = await supabaseClient
                        .from('orders')
                        .update({ status: newStatus })
                        .eq('id', orderId);
                    
                    if (error) throw error;
                }
                
                // Update local order status
                order.status = newStatus;
                
                // Refresh vendor data
                loadVendorData();
                
                const statusMessages = {
                    'processing': 'Pesanan sedang diproses',
                    'delivered': 'Pesanan telah selesai',
                    'cancelled': 'Pesanan dibatalkan'
                };
                
                showNotification(statusMessages[newStatus] || 'Status pesanan diperbarui', 'success');
                
            } catch (error) {
                console.error('Error updating order status:', error);
                showNotification('Gagal mengubah status pesanan: ' + error.message, 'error');
            }
        }

        // Update order status (for admin)
        async function updateOrderStatusAdmin(orderId, newStatus) {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Hanya admin yang dapat mengubah status pesanan', 'error');
                return;
            }
            
            try {
                // Find the order
                const order = orders.find(o => o.id == orderId);
                if (!order) {
                    showNotification('Pesanan tidak ditemukan', 'error');
                    return;
                }
                
                // Update status in database if Supabase is connected
                if (supabaseClient) {
                    const { error } = await supabaseClient
                        .from('orders')
                        .update({ status: newStatus })
                        .eq('id', orderId);
                    
                    if (error) throw error;
                }
                
                // Update local order status
                order.status = newStatus;
                
                // Refresh admin data
                loadAdminData();
                
                const statusMessages = {
                    'processing': 'Pesanan sedang diproses',
                    'delivered': 'Pesanan telah selesai',
                    'cancelled': 'Pesanan dibatalkan'
                };
                
                showNotification(statusMessages[newStatus] || 'Status pesanan diperbarui', 'success');
                
            } catch (error) {
                console.error('Error updating order status:', error);
                showNotification('Gagal mengubah status pesanan: ' + error.message, 'error');
            }
        }

        // Load admin products page
        function loadAdminProducts() {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Hanya admin yang dapat melihat daftar produk', 'error');
                showSection('admin');
                return;
            }
            
            // Update admin product vendor filter
            updateAdminProductVendorFilters();
            
            // Load products table
            loadAdminProductsTable();
        }

        // Update admin product vendor filter dropdown
        async function updateAdminProductVendorFilters() {
            const select = document.getElementById('adminProductVendorFilter');
            if (!select) return;
            
            try {
                // Get unique vendor categories from active vendors
                const { data: vendors, error } = await supabaseClient
                    .from('users')
                    .select('vendor_category')
                    .eq('role', 'vendor')
                    .not('vendor_category', 'is', null);
                
                if (error) throw error;
                
                // Get unique categories
                const uniqueCategories = [...new Set(vendors.map(v => v.vendor_category).filter(Boolean))];
                
                // Keep the "Semua Vendor" option and add dynamic vendor options
                let optionsHTML = '<option value="">Semua Vendor</option>';
                
                uniqueCategories.forEach(category => {
                    optionsHTML += `<option value="${category}">${getVendorName(category)}</option>`;
                });
                
                select.innerHTML = optionsHTML;
                
            } catch (error) {
                console.error('Error loading admin product vendor filters:', error);
                // Fallback to default categories if database fails
                const defaultCategories = ['pin-kopi', 'satset-grill', 'ani-ksf'];
                let optionsHTML = '<option value="">Semua Vendor</option>';
                defaultCategories.forEach(category => {
                    optionsHTML += `<option value="${category}">${getVendorName(category)}</option>`;
                });
                select.innerHTML = optionsHTML;
            }
        }

        // Apply admin product filters
        function applyAdminProductFilters() {
            loadAdminProductsTable();
        }

        // Reset admin product filters
        function resetAdminProductFilters() {
            document.getElementById('adminProductVendorFilter').value = '';
            document.getElementById('adminProductStockFilter').value = '';
            document.getElementById('adminProductSortFilter').value = 'newest';
            loadAdminProductsTable();
        }

        // Get filtered products for admin
        function getFilteredAdminProducts() {
            const vendorFilter = document.getElementById('adminProductVendorFilter')?.value || '';
            const stockFilter = document.getElementById('adminProductStockFilter')?.value || '';
            const sortFilter = document.getElementById('adminProductSortFilter')?.value || 'newest';
            
            let filteredProducts = [...products];
            
            // Filter by vendor
            if (vendorFilter) {
                filteredProducts = filteredProducts.filter(product => product.category === vendorFilter);
            }
            
            // Filter by stock status
            if (stockFilter) {
                filteredProducts = filteredProducts.filter(product => {
                    const stock = product.stock || 0;
                    switch (stockFilter) {
                        case 'available': return stock > 0;
                        case 'low': return stock > 0 && stock <= 10;
                        case 'out': return stock === 0;
                        default: return true;
                    }
                });
            }
            
            // Sort products
            filteredProducts.sort((a, b) => {
                switch (sortFilter) {
                    case 'newest':
                        return new Date(b.created_at) - new Date(a.created_at);
                    case 'oldest':
                        return new Date(a.created_at) - new Date(b.created_at);
                    case 'name_asc':
                        return (a.name || '').localeCompare(b.name || '');
                    case 'name_desc':
                        return (b.name || '').localeCompare(a.name || '');
                    case 'price_asc':
                        return (a.price || 0) - (b.price || 0);
                    case 'price_desc':
                        return (b.price || 0) - (a.price || 0);
                    case 'stock_asc':
                        return (a.stock || 0) - (b.stock || 0);
                    case 'stock_desc':
                        return (b.stock || 0) - (a.stock || 0);
                    default:
                        return 0;
                }
            });
            
            return filteredProducts;
        }

        // Calculate product statistics
        function calculateProductStats(filteredProducts) {
            let availableCount = 0;
            let lowStockCount = 0;
            let outOfStockCount = 0;
            
            filteredProducts.forEach(product => {
                const stock = product.stock || 0;
                if (stock === 0) {
                    outOfStockCount++;
                } else if (stock <= 10) {
                    lowStockCount++;
                } else {
                    availableCount++;
                }
            });
            
            return {
                available: availableCount,
                lowStock: lowStockCount,
                outOfStock: outOfStockCount
            };
        }

        // Load admin products table
        async function loadAdminProductsTable() {
            const tableContainer = document.getElementById('adminProductsTable');
            
            if (!currentUser || currentUser.role !== 'admin') return;
            
            try {
                // Get filtered products
                const filteredProducts = getFilteredAdminProducts();
                
                // Calculate statistics
                const productStats = calculateProductStats(filteredProducts);
                const allProductStats = calculateProductStats(products);
                
                // Update counters
                if (document.getElementById('filteredProductsCount')) {
                    document.getElementById('filteredProductsCount').textContent = filteredProducts.length;
                    document.getElementById('totalProductsCount').textContent = products.length;
                    document.getElementById('availableProductsCount').textContent = allProductStats.available;
                    document.getElementById('lowStockProductsCount').textContent = allProductStats.lowStock;
                    document.getElementById('outOfStockProductsCount').textContent = allProductStats.outOfStock;
                }
                
                if (filteredProducts.length === 0) {
                    tableContainer.innerHTML = `
                        <div class="p-8 text-center">
                            <div class="bg-gray-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-box-open text-gray-400 text-3xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-4">Tidak Ada Produk</h3>
                            <p class="text-gray-600 mb-4">
                                ${products.length === 0 ? 'Belum ada produk yang ditambahkan oleh vendor' : 'Tidak ada produk yang sesuai dengan filter'}
                            </p>
                            ${products.length > 0 ? `
                                <button onclick="resetAdminProductFilters()" class="text-blue-600 hover:text-blue-800 font-medium">
                                    <i class="fas fa-refresh mr-2"></i>Reset Filter
                                </button>
                            ` : ''}
                        </div>
                    `;
                    return;
                }
                
                // Render products table
                const table = `
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Produk</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Vendor</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Tipe</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Deskripsi</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Harga</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Stok</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Status</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Ditambahkan</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${filteredProducts.map(product => `
                                <tr class="hover:bg-gray-50">
                                    <td class="py-4 px-6">
                                        <div class="flex items-center">
                                            <img src="${product.image_url || 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400'}" 
                                                 alt="${product.name}" 
                                                 class="w-12 h-12 object-cover rounded-lg mr-4"
                                                 onerror="this.src='https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400'">
                                            <div>
                                                <p class="font-medium text-gray-900">${product.name}</p>
                                                <p class="text-sm text-gray-500">ID: ${product.id}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="py-4 px-6">
                                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                                            ${getVendorName(product.category)}
                                        </span>
                                    </td>
                                    <td class="py-4 px-6 text-sm text-gray-600">
                                        ${product.type || '-'}
                                    </td>
                                    <td class="py-4 px-6">
                                        <p class="text-sm text-gray-900 max-w-xs truncate" title="${product.description || 'Tidak ada deskripsi'}">
                                            ${product.description || 'Tidak ada deskripsi'}
                                        </p>
                                    </td>
                                    <td class="py-4 px-6">
                                        <p class="font-medium text-gray-900">Rp ${formatPrice(product.price || 0)}</p>
                                    </td>
                                    <td class="py-4 px-6">
                                        <div class="flex items-center">
                                            <span class="font-medium ${(product.stock || 0) > 10 ? 'text-green-600' : (product.stock || 0) > 0 ? 'text-yellow-600' : 'text-red-600'}">
                                                ${product.stock || 0}
                                            </span>
                                            <span class="text-sm text-gray-500 ml-1">unit</span>
                                        </div>
                                    </td>
                                    <td class="py-4 px-6">
                                        <span class="px-3 py-1 rounded-full text-sm font-medium ${
                                            (product.stock || 0) === 0 ? 'bg-red-100 text-red-800' :
                                            (product.stock || 0) <= 10 ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-green-100 text-green-800'
                                        }">
                                            ${
                                                (product.stock || 0) === 0 ? 'Habis' :
                                                (product.stock || 0) <= 10 ? 'Stok Rendah' :
                                                'Tersedia'
                                            }
                                        </span>
                                    </td>
                                    <td class="py-4 px-6 text-sm text-gray-600">
                                        ${new Date(product.created_at).toLocaleDateString('id-ID', {
                                            day: 'numeric',
                                            month: 'short',
                                            year: 'numeric'
                                        })}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                tableContainer.innerHTML = table;
                
            } catch (error) {
                console.error('Error loading admin products:', error);
                tableContainer.innerHTML = `
                    <div class="p-8 text-center">
                        <i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-4"></i>
                        <p class="text-red-600">Gagal memuat data produk: ${error.message}</p>
                        <button onclick="loadAdminProductsTable()" class="mt-4 text-blue-600 hover:text-blue-800 font-medium">
                            <i class="fas fa-refresh mr-2"></i>Coba Lagi
                        </button>
                    </div>
                `;
            }
        }

        // Load vendors management page
        function loadVendorsManagement() {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Hanya admin yang dapat mengelola vendor', 'error');
                showSection('admin');
                return;
            }
            
            loadVendorsTable();
        }

        // Show add vendor form
        async function showAddVendorForm() {
            await loadDynamicVendorCategories();
            document.getElementById('addVendorForm').classList.remove('hidden');
        }

        // Load dynamic vendor categories for dropdowns
        async function loadDynamicVendorCategories() {
            if (!supabaseClient) return;
            
            try {
                // Get unique vendor categories from existing vendors
                const { data: vendors, error } = await supabaseClient
                    .from('users')
                    .select('vendor_category')
                    .eq('role', 'vendor')
                    .not('vendor_category', 'is', null);
                
                if (error) throw error;
                
                // Get unique categories
                const existingCategories = [...new Set(vendors.map(v => v.vendor_category).filter(Boolean))];
                
                console.log('Existing vendor categories:', existingCategories);
                
                // Update add vendor form dropdown
                updateVendorCategoryDropdown('vendorCategorySelect', existingCategories);
                
            } catch (error) {
                console.error('Error loading dynamic vendor categories:', error);
                // Fallback to empty options if database fails
                updateVendorCategoryDropdown('vendorCategorySelect', []);
            }
        }

        // Update vendor category dropdown with dynamic options
        function updateVendorCategoryDropdown(selectId, existingCategories) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            let optionsHTML = '<option value="">Pilih Kategori Vendor</option>';
            
            // Add existing categories
            existingCategories.forEach(category => {
                optionsHTML += `<option value="${category}">${getVendorName(category)}</option>`;
            });
            
            // Always add custom option
            optionsHTML += '<option value="custom">Kategori Baru (Custom)</option>';
            
            select.innerHTML = optionsHTML;
        }

        // Hide add vendor form
        function hideAddVendorForm() {
            document.getElementById('addVendorForm').classList.add('hidden');
            resetVendorForm();
        }

        // Check user email for vendor conversion
        async function checkUserEmail() {
            const email = document.getElementById('vendorEmailCheck').value.trim();
            
            if (!email) {
                showNotification('Masukkan email user terlebih dahulu', 'error');
                return;
            }
            
            if (!supabaseClient) {
                showNotification('Koneksi database tidak tersedia. Silakan setup Supabase terlebih dahulu.', 'error');
                return;
            }
            
            // Validasi format email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showNotification('Format email tidak valid', 'error');
                return;
            }
            
            try {
                console.log('Checking user email:', email);
                
                // Cek apakah user dengan email tersebut ada
                const { data: existingUser, error: checkError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('email', email)
                    .single();
                
                if (checkError) {
                    if (checkError.code === 'PGRST116') {
                        showNotification('User dengan email tersebut tidak ditemukan. User harus mendaftar terlebih dahulu.', 'error');
                    } else {
                        console.error('Check user error:', checkError);
                        showNotification('Gagal mengecek user: ' + checkError.message, 'error');
                    }
                    return;
                }
                
                if (!existingUser) {
                    showNotification('User dengan email tersebut tidak ditemukan', 'error');
                    return;
                }
                
                // Cek apakah user sudah menjadi vendor
                if (existingUser.role === 'vendor') {
                    showNotification('User ini sudah menjadi vendor dengan kategori: ' + getVendorName(existingUser.vendor_category), 'error');
                    return;
                }
                
                // Cek apakah user adalah admin
                if (existingUser.role === 'admin') {
                    showNotification('User ini adalah admin, tidak bisa dijadikan vendor', 'error');
                    return;
                }
                
                // User ditemukan dan valid, tampilkan form detail
                console.log('User found:', existingUser);
                
                // Fill form dengan data user
                document.getElementById('vendorName').value = existingUser.full_name || '';
                document.getElementById('vendorEmail').value = existingUser.email || '';
                document.getElementById('vendorPhone').value = existingUser.phone_number || '';
                
                // Simpan data user untuk proses selanjutnya
                window.selectedUserForVendor = existingUser;
                
                // Hide email check step, show vendor details step
                document.getElementById('emailCheckStep').classList.add('hidden');
                document.getElementById('vendorDetailsStep').classList.remove('hidden');
                
                showNotification('User ditemukan! Silakan pilih kategori vendor.', 'success');
                
            } catch (error) {
                console.error('Error checking user email:', error);
                showNotification('Gagal mengecek user: ' + error.message, 'error');
            }
        }

        // Toggle custom category field
        function toggleCustomCategory() {
            const categorySelect = document.getElementById('vendorCategorySelect');
            const customField = document.getElementById('customCategoryField');
            
            if (categorySelect.value === 'custom') {
                customField.classList.remove('hidden');
                document.getElementById('vendorCategoryCustom').required = true;
            } else {
                customField.classList.add('hidden');
                document.getElementById('vendorCategoryCustom').required = false;
                document.getElementById('vendorCategoryCustom').value = '';
            }
        }

        // Reset vendor form to initial state
        function resetVendorForm() {
            document.getElementById('emailCheckStep').classList.remove('hidden');
            document.getElementById('vendorDetailsStep').classList.add('hidden');
            document.getElementById('vendorEmailCheck').value = '';
            document.getElementById('vendorForm').reset();
            document.getElementById('customCategoryField').classList.add('hidden');
            window.selectedUserForVendor = null;
        }

        // Handle add vendor (now converts existing user to vendor)
        async function handleAddVendor(e) {
            e.preventDefault();
            
            if (!supabaseClient) {
                showNotification('Koneksi database tidak tersedia. Silakan setup Supabase terlebih dahulu.', 'error');
                return;
            }
            
            if (!window.selectedUserForVendor) {
                showNotification('Data user tidak ditemukan. Silakan cek email terlebih dahulu.', 'error');
                return;
            }
            
            const categorySelect = document.getElementById('vendorCategorySelect').value;
            const customCategory = document.getElementById('vendorCategoryCustom').value.trim().toLowerCase();
            const phone = document.getElementById('vendorPhone').value.trim();
            
            // Determine final category
            let finalCategory = '';
            if (categorySelect === 'custom') {
                if (!customCategory) {
                    showNotification('Masukkan kategori custom', 'error');
                    return;
                }
                
                // Validasi format kategori custom
                const categoryRegex = /^[a-z0-9]+(-[a-z0-9]+)*$/;
                if (!categoryRegex.test(customCategory)) {
                    showNotification('Kategori harus menggunakan huruf kecil dan tanda hubung (contoh: toko-elektronik)', 'error');
                    return;
                }
                finalCategory = customCategory;
            } else {
                if (!categorySelect) {
                    showNotification('Pilih kategori vendor', 'error');
                    return;
                }
                finalCategory = categorySelect;
            }
            
            try {
                console.log('Converting user to vendor:', {
                    userId: window.selectedUserForVendor.id,
                    email: window.selectedUserForVendor.email,
                    category: finalCategory,
                    phone: phone
                });
                
                // Update user role dan vendor category
                const updateData = {
                    role: 'vendor',
                    vendor_category: finalCategory,
                    updated_at: new Date().toISOString()
                };
                
                // Update phone jika diisi
                if (phone) {
                    updateData.phone_number = phone;
                }
                
                const { data: updatedUser, error: updateError } = await supabaseClient
                    .from('users')
                    .update(updateData)
                    .eq('id', window.selectedUserForVendor.id)
                    .select()
                    .single();
                
                if (updateError) {
                    console.error('Update user error:', updateError);
                    throw updateError;
                }
                
                console.log('User successfully converted to vendor:', updatedUser);
                
                showNotification(`${window.selectedUserForVendor.full_name} berhasil dijadikan vendor ${getVendorName(finalCategory)}!`, 'success');
                hideAddVendorForm();
                loadVendorsTable();
                
                // Refresh vendor filters since we have a new vendor category
                await loadVendorFilters();
                
                // Update active vendors count
                const activeVendorsElement = document.getElementById('activeVendorsCount');
                if (activeVendorsElement) {
                    const currentCount = parseInt(activeVendorsElement.textContent) || 0;
                    activeVendorsElement.textContent = currentCount + 1;
                }
                
            } catch (error) {
                console.error('Error converting user to vendor:', error);
                
                let errorMessage = 'Gagal mengubah user menjadi vendor';
                if (error.message) {
                    errorMessage += ': ' + error.message;
                }
                
                // Handle specific database errors
                if (error.code === '23505') {
                    errorMessage = 'Terjadi konflik data. User mungkin sudah menjadi vendor.';
                } else if (error.code === '23502') {
                    errorMessage = 'Ada field wajib yang belum diisi.';
                } else if (error.code === '42703') {
                    errorMessage = 'Struktur tabel database tidak sesuai.';
                }
                
                showNotification(errorMessage, 'error');
            }
        }

        // Load vendors table
        async function loadVendorsTable() {
            const tableContainer = document.getElementById('vendorsTable');
            
            try {
                let vendorUsers = [];
                
                if (supabaseClient) {
                    // Load vendor users from database
                    const { data, error } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('role', 'vendor')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    vendorUsers = data || [];
                } else {
                    showNotification('Koneksi database tidak tersedia. Silakan setup Supabase terlebih dahulu.', 'error');
                    return;
                }
                
                // Update total count
                document.getElementById('totalVendorsCount').textContent = vendorUsers.length;
                
                if (vendorUsers.length === 0) {
                    tableContainer.innerHTML = `
                        <div class="p-8 text-center">
                            <div class="bg-gray-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-store text-gray-400 text-3xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-4">Belum Ada Vendor</h3>
                            <p class="text-gray-600 mb-4">Belum ada vendor yang terdaftar di platform</p>
                            <button onclick="showAddVendorForm()" class="bg-gradient-to-r from-green-500 to-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:from-green-600 hover:to-blue-700 transition-all">
                                <i class="fas fa-plus mr-2"></i>Tambah Vendor Pertama
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // Calculate vendor statistics
                const vendorStats = vendorUsers.map(vendor => {
                    const vendorProducts = products.filter(p => p.category === vendor.vendor_category);
                    const vendorOrders = orders.filter(order => 
                        order.items && order.items.some(item => item.category === vendor.vendor_category)
                    );
                    const vendorRevenue = vendorOrders.reduce((sum, order) => {
                        const vendorItems = (order.items || []).filter(item => item.category === vendor.vendor_category);
                        return sum + vendorItems.reduce((itemSum, item) => itemSum + (item.price * item.quantity), 0);
                    }, 0);
                    
                    return {
                        ...vendor,
                        totalProducts: vendorProducts.length,
                        totalOrders: vendorOrders.length,
                        totalRevenue: vendorRevenue
                    };
                });
                
                // Render vendors table
                const table = `
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Vendor</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Kategori</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Kontak</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Statistik</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Bergabung</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${vendorStats.map(vendor => `
                                <tr class="hover:bg-gray-50">
                                    <td class="py-4 px-6">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                            <div>
                                                <p class="font-medium text-gray-900">${vendor.full_name || vendor.name || 'Vendor'}</p>
                                                <p class="text-sm text-gray-500">${vendor.email}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="py-4 px-6">
                                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                                            ${getVendorName(vendor.vendor_category)}
                                        </span>
                                    </td>
                                    <td class="py-4 px-6">
                                        <div class="text-sm">
                                            <p class="text-gray-900">${vendor.phone_number || 'Tidak ada'}</p>
                                            <p class="text-gray-500">${vendor.email}</p>
                                        </div>
                                    </td>
                                    <td class="py-4 px-6">
                                        <div class="text-sm space-y-1">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Produk:</span>
                                                <span class="font-medium">${vendor.totalProducts}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Pesanan:</span>
                                                <span class="font-medium">${vendor.totalOrders}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Revenue:</span>
                                                <span class="font-medium text-green-600">Rp ${formatPrice(vendor.totalRevenue)}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="py-4 px-6 text-sm text-gray-600">
                                        ${new Date(vendor.created_at).toLocaleDateString('id-ID', {
                                            day: 'numeric',
                                            month: 'short',
                                            year: 'numeric'
                                        })}
                                    </td>
                                    <td class="py-4 px-6">
                                        <div class="flex space-x-2">
                                            <button onclick="editVendor('${vendor.id}')" 
                                                    class="text-blue-600 hover:text-blue-800 transition-colors" 
                                                    title="Edit Vendor">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteVendor('${vendor.id}', '${vendor.full_name || vendor.name}')" 
                                                    class="text-red-600 hover:text-red-800 transition-colors" 
                                                    title="Hapus Vendor">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                tableContainer.innerHTML = table;
                
                // Update active vendors count in admin dashboard
                const activeVendorsElement = document.getElementById('activeVendorsCount');
                if (activeVendorsElement) {
                    activeVendorsElement.textContent = vendorUsers.length;
                }
                
            } catch (error) {
                console.error('Error loading vendors:', error);
                tableContainer.innerHTML = `
                    <div class="p-8 text-center">
                        <i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-4"></i>
                        <p class="text-red-600">Gagal memuat data vendor: ${error.message}</p>
                        <button onclick="loadVendorsTable()" class="mt-4 text-blue-600 hover:text-blue-800 font-medium">
                            <i class="fas fa-refresh mr-2"></i>Coba Lagi
                        </button>
                    </div>
                `;
            }
        }

        // Edit vendor
        async function editVendor(vendorId) {
            if (!supabaseClient) {
                showNotification('Koneksi database tidak tersedia', 'error');
                return;
            }
            
            try {
                // Get vendor data
                const { data: vendor, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', vendorId)
                    .eq('role', 'vendor')
                    .single();
                
                if (error) throw error;
                
                if (!vendor) {
                    showNotification('Vendor tidak ditemukan', 'error');
                    return;
                }
                
                // Show edit modal
                await showEditVendorModal(vendor);
                
            } catch (error) {
                console.error('Error loading vendor data:', error);
                showNotification('Gagal memuat data vendor: ' + error.message, 'error');
            }
        }

        // Show edit vendor modal
        async function showEditVendorModal(vendor) {
            // Load dynamic categories first
            let existingCategories = [];
            if (supabaseClient) {
                try {
                    const { data: vendors, error } = await supabaseClient
                        .from('users')
                        .select('vendor_category')
                        .eq('role', 'vendor')
                        .not('vendor_category', 'is', null);
                    
                    if (!error) {
                        existingCategories = [...new Set(vendors.map(v => v.vendor_category).filter(Boolean))];
                    }
                } catch (error) {
                    console.error('Error loading categories for edit modal:', error);
                }
            }
            
            // Build category options dynamically
            let categoryOptionsHTML = '<option value="">Pilih Kategori Vendor</option>';
            
            // Add existing categories
            existingCategories.forEach(category => {
                const isSelected = vendor.vendor_category === category ? 'selected' : '';
                categoryOptionsHTML += `<option value="${category}" ${isSelected}>${getVendorName(category)}</option>`;
            });
            
            // Add custom option
            const isCustomSelected = !existingCategories.includes(vendor.vendor_category) && vendor.vendor_category ? 'selected' : '';
            categoryOptionsHTML += `<option value="custom" ${isCustomSelected}>Kategori Custom</option>`;
            
            // Determine if custom field should be shown
            const showCustomField = !existingCategories.includes(vendor.vendor_category) && vendor.vendor_category;
            const customFieldClass = showCustomField ? '' : 'hidden';
            const customFieldValue = showCustomField ? vendor.vendor_category : '';
            
            // Create modal HTML
            const modalHTML = `
                <div id="editVendorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md">
                        <div class="p-6">
                            <div class="text-center mb-6">
                                <div class="mx-auto w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mb-4">
                                    <i class="fas fa-user-edit text-white text-2xl"></i>
                                </div>
                                <h2 class="text-2xl font-bold text-gray-900">Edit Vendor</h2>
                                <p class="text-gray-600 text-sm mt-2">Ubah informasi vendor</p>
                            </div>

                            <form id="editVendorForm" class="space-y-4">
                                <input type="hidden" id="editVendorId" value="${vendor.id}">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                    <input type="text" id="editVendorName" value="${vendor.full_name || ''}" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" id="editVendorEmail" value="${vendor.email}" readonly
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                                    <p class="text-xs text-gray-500 mt-1">Email tidak dapat diubah</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nomor Telepon</label>
                                    <input type="tel" id="editVendorPhone" value="${vendor.phone_number || ''}"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kategori Vendor</label>
                                    <select id="editVendorCategory" required onchange="toggleEditCustomCategory()"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        ${categoryOptionsHTML}
                                    </select>
                                </div>
                                <div id="editCustomCategoryField" class="${customFieldClass}">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kategori Custom</label>
                                    <input type="text" id="editVendorCategoryCustom" value="${customFieldValue}"
                                           placeholder="Contoh: toko-elektronik, warung-makan"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">Gunakan format: huruf kecil dengan tanda hubung</p>
                                </div>
                                <div class="flex space-x-3 pt-4">
                                    <button type="submit" 
                                            class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-medium hover:from-blue-600 hover:to-purple-700 transition-all">
                                        <i class="fas fa-save mr-2"></i>Simpan Perubahan
                                    </button>
                                    <button type="button" onclick="hideEditVendorModal()" 
                                            class="flex-1 bg-gray-600 text-white py-3 rounded-lg font-medium hover:bg-gray-700 transition-all">
                                        <i class="fas fa-times mr-2"></i>Batal
                                    </button>
                                </div>
                            </form>

                            <button onclick="hideEditVendorModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add event listener for form submission
            document.getElementById('editVendorForm').addEventListener('submit', handleEditVendor);
        }

        // Toggle custom category field in edit modal
        function toggleEditCustomCategory() {
            const categorySelect = document.getElementById('editVendorCategory');
            const customField = document.getElementById('editCustomCategoryField');
            
            if (categorySelect.value === 'custom') {
                customField.classList.remove('hidden');
                document.getElementById('editVendorCategoryCustom').required = true;
            } else {
                customField.classList.add('hidden');
                document.getElementById('editVendorCategoryCustom').required = false;
                document.getElementById('editVendorCategoryCustom').value = '';
            }
        }

        // Hide edit vendor modal
        function hideEditVendorModal() {
            const modal = document.getElementById('editVendorModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle edit vendor form submission
        async function handleEditVendor(e) {
            e.preventDefault();
            
            if (!supabaseClient) {
                showNotification('Koneksi database tidak tersedia', 'error');
                return;
            }
            
            const vendorId = document.getElementById('editVendorId').value;
            const name = document.getElementById('editVendorName').value.trim();
            const phone = document.getElementById('editVendorPhone').value.trim();
            const categorySelect = document.getElementById('editVendorCategory').value;
            const customCategory = document.getElementById('editVendorCategoryCustom').value.trim().toLowerCase();
            
            // Determine final category
            let finalCategory = '';
            if (categorySelect === 'custom') {
                if (!customCategory) {
                    showNotification('Masukkan kategori custom', 'error');
                    return;
                }
                
                // Validasi format kategori custom
                const categoryRegex = /^[a-z0-9]+(-[a-z0-9]+)*$/;
                if (!categoryRegex.test(customCategory)) {
                    showNotification('Kategori harus menggunakan huruf kecil dan tanda hubung (contoh: toko-elektronik)', 'error');
                    return;
                }
                finalCategory = customCategory;
            } else {
                if (!categorySelect) {
                    showNotification('Pilih kategori vendor', 'error');
                    return;
                }
                finalCategory = categorySelect;
            }
            
            try {
                // Update vendor data
                const updateData = {
                    full_name: name,
                    phone_number: phone || null,
                    vendor_category: finalCategory,
                    updated_at: new Date().toISOString()
                };
                
                const { error } = await supabaseClient
                    .from('users')
                    .update(updateData)
                    .eq('id', vendorId);
                
                if (error) throw error;
                
                showNotification(`Vendor "${name}" berhasil diperbarui!`, 'success');
                hideEditVendorModal();
                loadVendorsTable();
                
                // Refresh vendor filters since categories might have changed
                await loadAdminVendorFilters();
                
            } catch (error) {
                console.error('Error updating vendor:', error);
                showNotification('Gagal memperbarui vendor: ' + error.message, 'error');
            }
        }

        // Delete vendor
        async function deleteVendor(vendorId, vendorName) {
            // Using custom modal instead of confirm()
            showConfirmationModal(`Apakah Anda yakin ingin menghapus vendor "${vendorName}"?<br><br>Vendor akan diubah kembali menjadi customer biasa.`, async () => {
                if (!supabaseClient) {
                    showNotification('Koneksi database tidak tersedia', 'error');
                    return;
                }
                
                try {
                    // Update user role back to customer
                    const { error } = await supabaseClient
                        .from('users')
                        .update({ 
                            role: 'customer',
                            vendor_category: null,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', vendorId);
                    
                    if (error) throw error;
                    
                    showNotification(`Vendor "${vendorName}" berhasil dihapus dan diubah kembali menjadi customer`, 'success');
                    loadVendorsTable();
                    
                    // Refresh vendor filters since vendor categories might have changed
                    await loadAdminVendorFilters();
                    
                } catch (error) {
                    console.error('Error deleting vendor:', error);
                    showNotification('Gagal menghapus vendor: ' + error.message, 'error');
                }
            });
        }

        // Load vendor products page
        function loadVendorProducts() {
            if (!currentUser || currentUser.role !== 'vendor') {
                showNotification('Hanya vendor yang dapat mengelola produk', 'error');
                showSection('vendor');
                return;
            }
            
            // Set vendor category name
            document.getElementById('vendorProductsCategoryName').textContent = getVendorName(currentUser.vendor_category);
            document.getElementById('autoCategory').textContent = getVendorName(currentUser.vendor_category);
            document.getElementById('productCategory').value = currentUser.vendor_category;
            
            loadVendorProductsTable();
        }

        // Show add product form
        function showAddProductForm() {
            document.getElementById('addProductForm').classList.remove('hidden');
        }

        // Hide add product form
        function hideAddProductForm() {
            document.getElementById('addProductForm').classList.add('hidden');
            document.getElementById('productForm').reset();
            document.getElementById('productCategory').value = currentUser.vendor_category;
        }

        // Handle add product
        async function handleAddProduct(e) {
            e.preventDefault();
            
            if (!supabaseClient) {
                showNotification('Koneksi database tidak tersedia. Silakan setup Supabase terlebih dahulu.', 'error');
                return;
            }
            
            if (!currentUser || currentUser.role !== 'vendor') {
                showNotification('Hanya vendor yang dapat menambah produk', 'error');
                return;
            }
            
            const name = document.getElementById('productName').value.trim();
            const description = document.getElementById('productDescription').value.trim();
            const price = parseInt(document.getElementById('productPrice').value);
            const stock = parseInt(document.getElementById('productStock').value);
            const imageUrl = document.getElementById('productImageUrl').value.trim();
            const type = document.getElementById('productType').value.trim();
            
            if (!name || !description || !price || stock < 0) {
                showNotification('Semua field wajib harus diisi dengan benar', 'error');
                return;
            }
            
            try {
                const newProduct = {
                    name: name,
                    description: description,
                    price: price,
                    stock: stock,
                    category: currentUser.vendor_category,
                    image_url: imageUrl || null,
                    type: type || null,
                    created_by: currentUser.id,
                    created_at: new Date().toISOString()
                };
                
                console.log('Creating product:', newProduct);
                
                // Save product to database
                const { data, error } = await supabaseClient
                    .from('products')
                    .insert([newProduct])
                    .select();
                
                if (error) throw error;
                
                // Update local products array
                if (data && data.length > 0) {
                    products.push(data[0]);
                    console.log('Product saved to database:', data[0]);
                }
                
                showNotification(`Produk "${name}" berhasil ditambahkan!`, 'success');
                hideAddProductForm();
                loadVendorProductsTable();
                
                // Refresh main products display
                renderProducts();
                
            } catch (error) {
                console.error('Error adding product:', error);
                showNotification('Gagal menambah produk: ' + error.message, 'error');
            }
        }

        // Load vendor products table
        async function loadVendorProductsTable() {
            const tableContainer = document.getElementById('vendorProductsTable');
            
            if (!currentUser || currentUser.role !== 'vendor') return;
            
            try {
                // Filter products by vendor category
                const vendorProducts = products.filter(p => p.category === currentUser.vendor_category);
                
                // Update total count
                document.getElementById('totalVendorProductsCount').textContent = vendorProducts.length;
                
                if (vendorProducts.length === 0) {
                    tableContainer.innerHTML = `
                        <div class="p-8 text-center">
                            <div class="bg-gray-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-box text-gray-400 text-3xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-4">Belum Ada Produk</h3>
                            <p class="text-gray-600 mb-4">Anda belum menambahkan produk apapun</p>
                            <button onclick="showAddProductForm()" class="bg-gradient-to-r from-green-500 to-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:from-green-600 hover:to-blue-700 transition-all">
                                <i class="fas fa-plus mr-2"></i>Tambah Produk Pertama
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // Sort products by creation date (newest first)
                const sortedProducts = vendorProducts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                // Render products table
                const table = `
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Produk</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Tipe</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Deskripsi</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Harga</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Stok</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Status</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Ditambahkan</th>
                                <th class="text-left py-4 px-6 font-medium text-gray-700">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${sortedProducts.map(product => `
                                <tr class="hover:bg-gray-50">
                                    <td class="py-4 px-6">
                                        <div class="flex items-center">
                                            <img src="${product.image_url || 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400'}" 
                                                 alt="${product.name}" 
                                                 class="w-12 h-12 object-cover rounded-lg mr-4"
                                                 onerror="this.src='https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400'">
                                            <div>
                                                <p class="font-medium text-gray-900">${product.name}</p>
                                                <p class="text-sm text-gray-500">${getVendorName(product.category)}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="py-4 px-6 text-sm text-gray-600">${product.type || '-'}</td>
                                    <td class="py-4 px-6">
                                        <p class="text-sm text-gray-900 max-w-xs truncate" title="${product.description || 'Tidak ada deskripsi'}">
                                            ${product.description || 'Tidak ada deskripsi'}
                                        </p>
                                    </td>
                                    <td class="py-4 px-6">
                                        <p class="font-medium text-gray-900">Rp ${formatPrice(product.price || 0)}</p>
                                    </td>
                                    <td class="py-4 px-6">
                                        <div class="flex items-center">
                                            <span class="font-medium ${(product.stock || 0) > 10 ? 'text-green-600' : (product.stock || 0) > 0 ? 'text-yellow-600' : 'text-red-600'}">
                                                ${product.stock || 0}
                                            </span>
                                            <span class="text-sm text-gray-500 ml-1">unit</span>
                                        </div>
                                    </td>
                                    <td class="py-4 px-6">
                                        <span class="px-3 py-1 rounded-full text-sm font-medium ${(product.stock || 0) > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${(product.stock || 0) > 0 ? 'Tersedia' : 'Habis'}
                                        </span>
                                    </td>
                                    <td class="py-4 px-6 text-sm text-gray-600">
                                        ${new Date(product.created_at).toLocaleDateString('id-ID', {
                                            day: 'numeric',
                                            month: 'short',
                                            year: 'numeric'
                                        })}
                                    </td>
                                    <td class="py-4 px-6">
                                        <div class="flex space-x-2">
                                            <button onclick="editProduct('${product.id}')" 
                                                    class="text-blue-600 hover:text-blue-800 transition-colors" 
                                                    title="Edit Produk">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteProduct('${product.id}', '${product.name}')" 
                                                    class="text-red-600 hover:text-red-800 transition-colors" 
                                                    title="Hapus Produk">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                tableContainer.innerHTML = table;
                
            } catch (error) {
                console.error('Error loading vendor products:', error);
                tableContainer.innerHTML = `
                    <div class="p-8 text-center">
                        <i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-4"></i>
                        <p class="text-red-600">Gagal memuat data produk: ${error.message}</p>
                        <button onclick="loadVendorProductsTable()" class="mt-4 text-blue-600 hover:text-blue-800 font-medium">
                            <i class="fas fa-refresh mr-2"></i>Coba Lagi
                        </button>
                    </div>
                `;
            }
        }

        // Edit product
        async function editProduct(productId) {
            if (!supabaseClient) {
                showNotification('Koneksi database tidak tersedia', 'error');
                return;
            }
            
            if (!currentUser || currentUser.role !== 'vendor') {
                showNotification('Hanya vendor yang dapat mengedit produk', 'error');
                return;
            }
            
            try {
                // Get product data
                const product = products.find(p => p.id == productId);
                if (!product) {
                    showNotification('Produk tidak ditemukan', 'error');
                    return;
                }
                
                // Check if this product belongs to current vendor
                if (product.category !== currentUser.vendor_category) {
                    showNotification('Anda hanya dapat mengedit produk dari kategori Anda sendiri', 'error');
                    return;
                }
                
                // Show edit modal
                showEditProductModal(product);
                
            } catch (error) {
                console.error('Error loading product data:', error);
                showNotification('Gagal memuat data produk: ' + error.message, 'error');
            }
        }

        // Show edit product modal
        function showEditProductModal(product) {
            // Create modal HTML
            const modalHTML = `
                <div id="editProductModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="text-center mb-6">
                                <div class="mx-auto w-16 h-16 bg-gradient-to-r from-green-500 to-blue-600 rounded-full flex items-center justify-center mb-4">
                                    <i class="fas fa-edit text-white text-2xl"></i>
                                </div>
                                <h2 class="text-2xl font-bold text-gray-900">Edit Produk</h2>
                                <p class="text-gray-600 text-sm mt-2">Ubah informasi produk Anda</p>
                            </div>

                            <form id="editProductForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="hidden" id="editProductId" value="${product.id}">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Produk *</label>
                                    <input type="text" id="editProductName" value="${product.name || ''}" required 
                                           placeholder="Contoh: Kopi Arabica Premium"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Harga *</label>
                                    <input type="number" id="editProductPrice" value="${product.price || ''}" required min="0" step="1"
                                           placeholder="25000"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Stok *</label>
                                    <input type="number" id="editProductStock" value="${product.stock || ''}" required min="0"
                                           placeholder="100"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipe (Opsional)</label>
                                    <input type="text" id="editProductType" value="${product.type || ''}" placeholder="Contoh: Makanan, Minuman"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                                    <input type="text" id="editProductCategory" value="${getVendorName(product.category)}" readonly 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                                    <p class="text-xs text-gray-500 mt-1">Kategori tidak dapat diubah</p>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi *</label>
                                    <textarea id="editProductDescription" required rows="3"
                                              placeholder="Deskripsi lengkap produk Anda..."
                                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none">${product.description || ''}</textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">URL Gambar (Opsional)</label>
                                    <input type="url" id="editProductImageUrl" value="${product.image_url || ''}"
                                           placeholder="https://example.com/image.jpg"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">Kosongkan untuk menggunakan gambar default</p>
                                </div>
                                <div class="md:col-span-2 flex space-x-3 pt-4">
                                    <button type="submit" 
                                            class="flex-1 bg-gradient-to-r from-green-500 to-blue-600 text-white py-3 rounded-lg font-medium hover:from-green-600 hover:to-blue-700 transition-all">
                                        <i class="fas fa-save mr-2"></i>Simpan Perubahan
                                    </button>
                                    <button type="button" onclick="hideEditProductModal()" 
                                            class="flex-1 bg-gray-600 text-white py-3 rounded-lg font-medium hover:bg-gray-700 transition-all">
                                        <i class="fas fa-times mr-2"></i>Batal
                                    </button>
                                </div>
                            </form>

                            <button onclick="hideEditProductModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add event listener for form submission
            document.getElementById('editProductForm').addEventListener('submit', handleEditProduct);
        }

        // Hide edit product modal
        function hideEditProductModal() {
            const modal = document.getElementById('editProductModal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle edit product form submission
        async function handleEditProduct(e) {
            e.preventDefault();
            
            if (!supabaseClient) {
                showNotification('Koneksi database tidak tersedia', 'error');
                return;
            }
            
            if (!currentUser || currentUser.role !== 'vendor') {
                showNotification('Hanya vendor yang dapat mengedit produk', 'error');
                return;
            }
            
            const productId = document.getElementById('editProductId').value;
            const name = document.getElementById('editProductName').value.trim();
            const description = document.getElementById('editProductDescription').value.trim();
            const price = parseInt(document.getElementById('editProductPrice').value);
            const stock = parseInt(document.getElementById('editProductStock').value);
            const imageUrl = document.getElementById('editProductImageUrl').value.trim();
            const type = document.getElementById('editProductType').value.trim();
            
            if (!name || !description || !price || stock < 0) {
                showNotification('Semua field wajib harus diisi dengan benar', 'error');
                return;
            }
            
            try {
                // Update product data
                const updateData = {
                    name: name,
                    description: description,
                    price: price,
                    stock: stock,
                    image_url: imageUrl || null,
                    type: type || null,
                    updated_at: new Date().toISOString()
                };
                
                const { error } = await supabaseClient
                    .from('products')
                    .update(updateData)
                    .eq('id', productId);
                
                if (error) throw error;
                
                // Update local products array
                const productIndex = products.findIndex(p => p.id == productId);
                if (productIndex > -1) {
                    products[productIndex] = { ...products[productIndex], ...updateData };
                }
                
                showNotification(`Produk "${name}" berhasil diperbarui!`, 'success');
                hideEditProductModal();
                loadVendorProductsTable();
                
                // Refresh main products display
                renderProducts();
                
            } catch (error) {
                console.error('Error updating product:', error);
                showNotification('Gagal memperbarui produk: ' + error.message, 'error');
            }
        }

        // Delete product
        async function deleteProduct(productId, productName) {
            showConfirmationModal(`Apakah Anda yakin ingin menghapus produk "${productName}"?`, async () => {
                if (!supabaseClient) {
                    showNotification('Koneksi database tidak tersedia', 'error');
                    return;
                }
                
                try {
                    // Delete product from database
                    const { error } = await supabaseClient
                        .from('products')
                        .delete()
                        .eq('id', productId);
                    
                    if (error) throw error;
                    
                    // Remove from local products array
                    const productIndex = products.findIndex(p => p.id == productId);
                    if (productIndex > -1) {
                        products.splice(productIndex, 1);
                    }
                    
                    showNotification(`Produk "${productName}" berhasil dihapus`, 'success');
                    loadVendorProductsTable();
                    
                    // Refresh main products display
                    renderProducts();
                    
                } catch (error) {
                    console.error('Error deleting product:', error);
                    showNotification('Gagal menghapus produk: ' + error.message, 'error');
                }
            });
        }
        
        // Print Order Invoice
        function printOrder(orderId) {
            const order = orders.find(o => o.id == orderId);
            if (!order) {
                showNotification('Pesanan tidak ditemukan', 'error');
                return;
            }

            const orderItems = order.items || [];
            const total = order.total || order.total_amount || 0;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Struk Pesanan #${order.id}</title>
                    <style>
                        body { font-family: 'Courier New', Courier, monospace; margin: 20px; color: #333; }
                        .container { width: 300px; margin: auto; }
                        h1 { text-align: center; margin: 0; font-size: 20px; }
                        h2 { text-align: center; margin: 5px 0 20px; font-size: 14px; border-bottom: 1px dashed #999; padding-bottom: 10px; }
                        p { margin: 2px 0; font-size: 12px; }
                        table { width: 100%; border-collapse: collapse; font-size: 12px; }
                        th, td { text-align: left; padding: 4px 0; }
                        .item-row td { vertical-align: top; }
                        .total-row td { border-top: 1px dashed #999; padding-top: 10px; font-weight: bold; }
                        .text-right { text-align: right; }
                        .footer { text-align: center; margin-top: 20px; font-size: 12px; border-top: 1px dashed #999; padding-top: 10px;}
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>Masakin Aja</h1>
                        <h2>Struk Pesanan</h2>
                        <p><strong>No. Pesanan:</strong> #${order.id}</p>
                        <p><strong>Tanggal:</strong> ${new Date(order.created_at).toLocaleString('id-ID')}</p>
                        <p><strong>Customer:</strong> ${order.customer_name || 'Customer'}</p>
                        <p><strong>Email:</strong> ${order.customer_email || 'No email'}</p>
                        <br>
                        <table>
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th class="text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${orderItems.map(item => `
                                    <tr class="item-row">
                                        <td>
                                            ${item.product_name || 'Produk'}<br>
                                            ${item.quantity || 1} x Rp ${formatPrice(item.price || 0)}
                                        </td>
                                        <td class="text-right">Rp ${formatPrice((item.price || 0) * (item.quantity || 1))}</td>
                                    </tr>
                                `).join('')}
                                <tr class="total-row">
                                    <td>Total</td>
                                    <td class="text-right">Rp ${formatPrice(total)}</td>
                                </tr>
                            </tbody>
                        </table>
                        <br>
                        <p><strong>Metode Pembayaran:</strong> ${getPaymentMethodText(order.payment_method || 'cash')}</p>
                        <div class="footer">
                            <p>Terima kasih telah berbelanja!</p>
                        </div>
                    </div>
                </body>
                </html>
            `);

            printWindow.document.close();
            printWindow.focus(); 
            
            // Use a timeout to ensure the content is fully loaded before printing
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        // Show notification
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50 max-w-sm ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas ${
                            type === 'success' ? 'fa-check-circle' :
                            type === 'error' ? 'fa-exclamation-circle' :
                            type === 'warning' ? 'fa-exclamation-triangle' :
                            'fa-info-circle'
                        } mr-3"></i>
                        <span>${message}</span>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Show confirmation modal (replacement for confirm())
        function showConfirmationModal(message, onConfirm) {
            // Remove existing modals
            hideConfirmationModal();

            const modalHTML = `
                <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm">
                        <div class="p-6">
                            <div class="text-center">
                                <div class="mx-auto w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mb-4">
                                    <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl"></i>
                                </div>
                                <h3 class="text-lg font-medium text-gray-900">Konfirmasi</h3>
                                <div class="mt-2 text-sm text-gray-600">
                                    <p>${message}</p>
                                </div>
                            </div>
                            <div class="mt-6 flex space-x-3">
                                <button id="confirmBtn" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-medium hover:bg-red-700 transition-colors">
                                    Ya, Lanjutkan
                                </button>
                                <button id="cancelBtn" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg font-medium hover:bg-gray-300 transition-colors">
                                    Batal
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            document.getElementById('confirmBtn').onclick = () => {
                onConfirm();
                hideConfirmationModal();
            };
            document.getElementById('cancelBtn').onclick = hideConfirmationModal;
        }

        function hideConfirmationModal() {
            const modal = document.getElementById('confirmationModal');
            if (modal) {
                modal.remove();
            }
        }
    </script>
</body>
</html>
